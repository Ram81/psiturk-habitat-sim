!function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=23)}([function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e){function n(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}t.exports=function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}},function(t,e){t.exports=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}},function(t,e){t.exports=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}},function(t,e,n){var i=n(12),s=n(13),o=n(14),r=n(16);t.exports=function(t,e){return i(t)||s(t,e)||o(t,e)||r()}},function(t,e){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},n(e)}t.exports=n},function(t,e,n){var i=n(17);function s(e,n,o){return"undefined"!=typeof Reflect&&Reflect.get?t.exports=s=Reflect.get:t.exports=s=function(t,e,n){var s=i(t,e);if(s){var o=Object.getOwnPropertyDescriptor(s,e);return o.get?o.get.call(n):o.value}},s(e,n,o||e)}t.exports=s},function(t,e,n){var i=n(18);t.exports=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&i(t,e)}},function(t,e,n){var i=n(9),s=n(2);t.exports=function(t,e){return!e||"object"!==i(e)&&"function"!=typeof e?s(t):e}},function(t,e){function n(e){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=n=function(t){return typeof t}:t.exports=n=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(e)}t.exports=n},function(t,e,n){"use strict";var i,s=function(){return void 0===i&&(i=Boolean(window&&document&&document.all&&!window.atob)),i},o=function(){var t={};return function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}t[e]=n}return t[e]}}(),r=[];function a(t){for(var e=-1,n=0;n<r.length;n++)if(r[n].identifier===t){e=n;break}return e}function c(t,e){for(var n={},i=[],s=0;s<t.length;s++){var o=t[s],c=e.base?o[0]+e.base:o[0],l=n[c]||0,u="".concat(c," ").concat(l);n[c]=l+1;var h=a(u),d={css:o[1],media:o[2],sourceMap:o[3]};-1!==h?(r[h].references++,r[h].updater(d)):r.push({identifier:u,updater:v(d,e),references:1}),i.push(u)}return i}function l(t){var e=document.createElement("style"),i=t.attributes||{};if(void 0===i.nonce){var s=n.nc;s&&(i.nonce=s)}if(Object.keys(i).forEach((function(t){e.setAttribute(t,i[t])})),"function"==typeof t.insert)t.insert(e);else{var r=o(t.insert||"head");if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(e)}return e}var u,h=(u=[],function(t,e){return u[t]=e,u.filter(Boolean).join("\n")});function d(t,e,n,i){var s=n?"":i.media?"@media ".concat(i.media," {").concat(i.css,"}"):i.css;if(t.styleSheet)t.styleSheet.cssText=h(e,s);else{var o=document.createTextNode(s),r=t.childNodes;r[e]&&t.removeChild(r[e]),r.length?t.insertBefore(o,r[e]):t.appendChild(o)}}function p(t,e,n){var i=n.css,s=n.media,o=n.sourceMap;if(s?t.setAttribute("media",s):t.removeAttribute("media"),o&&btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleSheet)t.styleSheet.cssText=i;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(i))}}var f=null,g=0;function v(t,e){var n,i,s;if(e.singleton){var o=g++;n=f||(f=l(e)),i=d.bind(null,n,o,!1),s=d.bind(null,n,o,!0)}else n=l(e),i=p.bind(null,n,e),s=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(n)};return i(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;i(t=e)}else s()}}t.exports=function(t,e){(e=e||{}).singleton||"boolean"==typeof e.singleton||(e.singleton=s());var n=c(t=t||[],e);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var i=0;i<n.length;i++){var s=a(n[i]);r[s].references--}for(var o=c(t,e),l=0;l<n.length;l++){var u=a(n[l]);0===r[u].references&&(r[u].updater(),r.splice(u,1))}n=o}}}},function(t,e,n){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var n=function(t,e){var n=t[1]||"",i=t[3];if(!i)return n;if(e&&"function"==typeof btoa){var s=(r=i,a=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),"/*# ".concat(c," */")),o=i.sources.map((function(t){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(t," */")}));return[n].concat(o).concat([s]).join("\n")}var r,a,c;return[n].join("\n")}(e,t);return e[2]?"@media ".concat(e[2]," {").concat(n,"}"):n})).join("")},e.i=function(t,n,i){"string"==typeof t&&(t=[[null,t,""]]);var s={};if(i)for(var o=0;o<this.length;o++){var r=this[o][0];null!=r&&(s[r]=!0)}for(var a=0;a<t.length;a++){var c=[].concat(t[a]);i&&s[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),e.push(c))}},e}},function(t,e){t.exports=function(t){if(Array.isArray(t))return t}},function(t,e){t.exports=function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var n=[],i=!0,s=!1,o=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done)&&(n.push(r.value),!e||n.length!==e);i=!0);}catch(t){s=!0,o=t}finally{try{i||null==a.return||a.return()}finally{if(s)throw o}}return n}}},function(t,e,n){var i=n(15);t.exports=function(t,e){if(t){if("string"==typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(t,e):void 0}}},function(t,e){t.exports=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(t,e,n){var i=n(5);t.exports=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=i(t)););return t}},function(t,e){function n(e,i){return t.exports=n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},n(e,i)}t.exports=n},function(t,e,n){var i=n(10),s=n(20);"string"==typeof(s=s.__esModule?s.default:s)&&(s=[[t.i,s,""]]);var o={insert:"head",singleton:!1};i(s,o);t.exports=s.locals||{}},function(t,e,n){(e=n(11)(!1)).push([t.i,".viewer-canvas {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  right: 0;\n  left: 0;\n  overflow: hidden;\n}\n\n.hidden {\n  display: hidden;\n}\n\n.tooltip {\n  color: #fff;\n  background-color: #666;\n  line-height: 2;\n  border-radius: 2px;\n  top: 0;\n  padding-top: 3px;\n  padding-bottom: 3px;\n  position: absolute;\n  z-index: 100;\n  text-align: center;\n  width: 100%;\n}\n\n.mobile-warning {\n  position: absolute;\n  bottom: 5px;\n}\n",""]),t.exports=e},function(t,e,n){var i=n(10),s=n(22);"string"==typeof(s=s.__esModule?s.default:s)&&(s=[[t.i,s,""]]);var o={insert:"head",singleton:!1};i(s,o);t.exports=s.locals||{}},function(t,e,n){(e=n(11)(!1)).push([t.i,"/** Copyright (c) Facebook, Inc. and its affiliates.\n *  This source code is licensed under the MIT license found in the\n *  LICENSE file in the root directory of this source tree.\n */\n#radar {\n  position: absolute;\n  top: 70%;\n  left: 50%;\n  margin-left: -50px;\n  width: 100;\n  height: 100;\n  z-index: 9;\n  pointer-events: none;\n  visibility: hidden;\n}\n\n#scope {\n  position: absolute;\n  border-color: red;\n  border-style: dashed;\n  border-width: 5px;\n  opacity: 0.4;\n  top: 50%;\n  left: 50%;\n  margin-left: -160px;\n  margin-top: -120px;\n  width: 320px;\n  height: 240px;\n  z-index: 9;\n  pointer-events: none;\n}\n\n#fps {\n  text-align: right;\n  padding-right: 1em;\n}\n\n#warning {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  z-index: 100;\n  background-color: #fff;\n  color: #000;\n}\n\n.hidden {\n  display: none !important;\n}\n\n.inventory-center {\n  margin-top: 1.5em;\n  text-align: center;\n}\n",""]),t.exports=e},function(t,e,n){"use strict";n.r(e);var i=n(0),s=n.n(i),o=n(1),r=n.n(o),a=n(3),c=n.n(a),l={height:1.5,radius:.1,mass:32,linearAcceleration:20,angularAcceleration:4*Math.PI,linearFriction:.5,angularFriction:1,coefficientOfRestitution:0},u={startState:{position:[-4.94049,-2.63092,-7.57733],rotation:[0,.980792,0,.195056]},goal:{position:[2.2896811962127686,.11950381100177765,16.97636604309082]}},h={height:480,width:640},d=-1===window.location.href.indexOf("localhost")?"https://habitat-resources.s3.amazonaws.com/data/scene_datasets/habitat-test-scenes/skokloster-castle.glb":"skokloster-castle.glb",p=["cylinderSolid_rings_1_segments_12_halfLen_1_useTexCoords_false_useTangents_false_capEnds_true"],f={objects:[{object:"apple",objectIcon:"/data/test_assets/objects/apple.png",objectHandle:"/data/objects/apple.phys_properties.json",physicsProperties:"test_assets/objects/apple.phys_properties.json",renderMesh:"test_assets/objects/apple.glb"},{object:"banana",objectIcon:"/data/test_assets/objects/banana.png",objectHandle:"/data/objects/banana.phys_properties.json",physicsProperties:"test_assets/objects/banana.phys_properties.json",renderMesh:"test_assets/objects/banana.glb"},{object:"cracker box",objectIcon:"/data/test_assets/objects/cracker_box.png",objectHandle:"/data/objects/cracker_box.phys_properties.json",physicsProperties:"test_assets/objects/cracker_box.phys_properties.json",renderMesh:"test_assets/objects/cracker_box.glb"},{object:"colored wood blocks",objectIcon:"/data/test_assets/objects/colored_wood_blocks.png",objectHandle:"/data/objects/colored_wood_blocks.phys_properties.json",physicsProperties:"test_assets/objects/colored_wood_blocks.phys_properties.json",renderMesh:"test_assets/objects/colored_wood_blocks.glb"},{object:"gelatin box",objectIcon:"/data/test_assets/objects/gelatin_box.png",objectHandle:"/data/objects/gelatin_box.phys_properties.json",physicsProperties:"test_assets/objects/gelatin_box.phys_properties.json",renderMesh:"test_assets/objects/gelatin_box.glb"},{object:"hammer",objectIcon:"/data/test_assets/objects/hammer.png",objectHandle:"/data/objects/hammer.phys_properties.json",physicsProperties:"test_assets/objects/hammer.phys_properties.json",renderMesh:"test_assets/objects/hammer.glb"},{object:"master chef can",objectIcon:"/data/test_assets/objects/master_chef_can.png",objectHandle:"/data/objects/master_chef_can.phys_properties.json",physicsProperties:"test_assets/objects/master_chef_can.phys_properties.json",renderMesh:"test_assets/objects/master_chef_can.glb"},{object:"soccer ball",objectIcon:"/data/test_assets/objects/mini_soccer_ball.png",objectHandle:"/data/objects/mini_soccer_ball.phys_properties.json",physicsProperties:"test_assets/objects/mini_soccer_ball.phys_properties.json",renderMesh:"test_assets/objects/mini_soccer_ball.glb"},{object:"mustard bottle",objectIcon:"/data/test_assets/objects/mustard_bottle.png",objectHandle:"/data/objects/mustard_bottle.phys_properties.json",physicsProperties:"test_assets/objects/mustard_bottle.phys_properties.json",renderMesh:"test_assets/objects/mustard_bottle.glb"},{object:"orange",objectIcon:"/data/test_assets/objects/orange.png",objectHandle:"/data/objects/orange.phys_properties.json",physicsProperties:"test_assets/objects/orange.phys_properties.json",renderMesh:"test_assets/objects/orange.glb"},{object:"red bowl",objectIcon:"/data/test_assets/objects/bowl.png",objectHandle:"/data/objects/bowl.phys_properties.json",physicsProperties:"test_assets/objects/bowl.phys_properties.json",renderMesh:"test_assets/objects/bowl.glb"},{object:"red mug",objectIcon:"/data/test_assets/objects/mug.png",objectHandle:"/data/objects/mug.phys_properties.json",physicsProperties:"test_assets/objects/mug.phys_properties.json",renderMesh:"test_assets/objects/mug.glb"},{object:"red plate",objectIcon:"/data/test_assets/objects/plate.png",objectHandle:"/data/objects/plate.phys_properties.json",physicsProperties:"test_assets/objects/plate.phys_properties.json",renderMesh:"test_assets/objects/plate.glb"},{object:"red sphere",objectIcon:"/data/test_assets/objects/sphere.png",objectHandle:"/data/objects/sphere.phys_properties.json",physicsProperties:"test_assets/objects/sphere.phys_properties.json",renderMesh:"test_assets/objects/sphere.glb"},{object:"tomato soup can",objectIcon:"/data/test_assets/objects/tomato_soup_can.png",objectHandle:"/data/objects/tomato_soup_can.phys_properties.json",physicsProperties:"test_assets/objects/tomato_soup_can.phys_properties.json",renderMesh:"test_assets/objects/tomato_soup_can.glb"},{object:"toy airplane",objectIcon:"/data/test_assets/objects/toy_airplane.png",objectHandle:"/data/objects/toy_airplane.phys_properties.json",physicsProperties:"test_assets/objects/toy_airplane.phys_properties.json",renderMesh:"test_assets/objects/toy_airplane.glb"},{object:"wood block",objectIcon:"/data/test_assets/objects/wood_block.png",objectHandle:"/data/objects/wood_block.phys_properties.json",physicsProperties:"test_assets/objects/wood_block.phys_properties.json",renderMesh:"test_assets/objects/wood_block.glb"}]},g={name:"replay_task_1.json",config:"tasks/replay_task_1.json"},v={name:"replay_task_1.csv",location:"replays/replay_task_1.csv"},b={tasks:[{name:"task_1.json",config:"tasks/task_1.json",scene:"house_with_empty_room.glb",flythroughTask:{name:"replay_task_1.json",config:"tasks/replay_task_1.json"},flythroughReplayFile:{name:"replay_task_1.csv",location:"replays/replay_task_1.csv"},trainingTask:{name:"training_task_1.json",config:"tasks/training_task_1.json"}},{name:"task_2.json",config:"tasks/task_2.json",scene:"empty_house.glb",flythroughTask:{name:"replay_task_2.json",config:"tasks/replay_task_2.json"},flythroughReplayFile:{name:"replay_task_2.csv",location:"replays/replay_task_2.csv"},trainingTask:{name:"training_task_2.json",config:"tasks/training_task_2.json"}},{name:"task_3.json",config:"tasks/task_3.json",scene:"house_with_empty_garage.glb",flythroughTask:{name:"replay_task_3.json",config:"tasks/replay_task_3.json"},flythroughReplayFile:{name:"replay_task_3.csv",location:"replays/replay_task_3.csv"},trainingTask:{name:"training_task_3.json",config:"tasks/training_task_3.json"}},{name:"task_4.json",config:"tasks/task_4.json",scene:"house.glb",flythroughTask:{name:"replay_task_4.json",config:"tasks/replay_task_4.json"},flythroughReplayFile:{name:"replay_task_4.csv",location:"replays/replay_task_4.csv"},trainingTask:{name:"training_task_4.json",config:"tasks/training_task_4.json"}}]},y=n(4),m=n.n(y),j=n(9),k=n.n(j);function w(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"==typeof t)return _(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _(t,e)}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return r=t.done,t},e:function(t){a=!0,o=t},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw o}}}}function _(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function O(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500,n=!1;return function(){var i=arguments,s=this;n||(t.apply(s,i),n=!0,window.setTimeout((function(){n=!1}),e))}}function S(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=w(window.location.search.substr(1).split("&"));try{for(n.s();!(t=n.n()).done;){var i=t.value,s=i.split("="),o=m()(s,2),r=o[0],a=o[1];r&&a&&(e[r]=decodeURIComponent(a))}}catch(t){n.e(t)}finally{n.f()}return e}function I(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5;return Math.floor(Math.random()*t)}function T(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{encoding:"utf8"},n=FS.readFile(t,{encoding:e.encoding}),i=JSON.parse(n);return i}function C(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"task.json",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"0",n=T(t),i={startState:{}};return i.episodeID=e,i.startState.position=n.episodes[e].start_position,i.startState.rotation=n.episodes[e].start_rotation,i.sceneID=n.episodes[e].scene_id,i.objects=n.episodes[e].objects,i.task=n.episodes[e].task,i}function M(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"0";return void 0===t?u:void 0===e?C(t):C(t,e)}var A=function(){function t(e){s()(this,t),this.psiturk=e}return r()(t,[{key:"handleRecordTrialData",value:function(t,e,n){this.psiturk&&0==window.config.disableLogging&&this.psiturk.recordTrialData({phase:t,event:e,data:n})}},{key:"handleRecordUnstructuredData",value:function(t,e){this.psiturk&&0==window.config.disableLogging&&this.psiturk.recordUnstructuredData(t,e)}}]),t}();function P(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"==typeof t)return x(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return x(t,e)}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return r=t.done,t},e:function(t){a=!0,o=t},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw o}}}}function x(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}var D=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;s()(this,t),this.sim=new Module.Simulator(e),this.pathfinder=this.sim.getPathFinder(),this.psiturk=new A(window.psiTurk),this.resolution=null,this.grippedObjectId=-1,this.nearestObjectId=-1,this.gripOffset=null,this.selectedAgentId=i,this.agentObjectHandle=p[0],this.setEpisode(n),window.config.recomputeNavMesh&&this.recomputeNavMesh(),this.maxDistance=1.5}return r()(t,[{key:"reset",value:function(){(this.sim.reset(),null!==this.initialAgentState)&&this.sim.getAgent(this.selectedAgentId).setState(this.initialAgentState,!0);this.updateCrossHairNode(this.getCrosshairPosition()),this.grippedObjectId=-1,this.nearestObjectId=-1,this.gripOffset=null,this.psiturk.handleRecordTrialData("TEST","simReset",{})}},{key:"changeAgent",value:function(t){this.selectedAgentId=t}},{key:"setEpisode",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.removeAllObjects(),this.episode=t,this.initialAgentState=null,this.objectsInScene=[],Object.keys(t).length>0){this.initialAgentState=this.createAgentState(t.startState),this.sim.addContactTestObject(this.agentObjectHandle,0);var e=t.objects;for(var n in e){var i=e[n].objectHandle,s=this.convertVec3fToVector3(e[n].position),o=this.addObjectAtLocation(i,s);this.addObjectInScene(o,e[n]),this.sim.addContactTestObject(i,0)}}else this.sim.addContactTestObject(this.agentObjectHandle,0);this.psiturk.handleRecordTrialData("TEST","setEpisode",{episode:t})}},{key:"updateCrossHairNode",value:function(t){this.sim.updateCrossHairNode(t)}},{key:"addObjectInScene",value:function(t,e){var n=JSON.parse(JSON.stringify(e));n.objectId=t,this.objectsInScene.push(n)}},{key:"updateObjectInScene",value:function(t,e){for(var n=0;n<this.objectsInScene.length;n++)if(this.objectsInScene[n].objectId==t){this.objectsInScene[n].objectId=e;break}}},{key:"getObjectFromScene",value:function(t){for(var e=0;e<this.objectsInScene.length;e++)if(this.objectsInScene[e].objectId==t)return this.objectsInScene[e];return null}},{key:"getObjectsInScene",value:function(){return this.objectsInScene}},{key:"syncObjects",value:function(){this.sim.syncGrippedObject(this.grippedObjectId)}},{key:"addObjectAtLocation",value:function(t,e){var n=this.addObjectByHandle(t);return this.setTranslation(e,n,0),this.sampleObjectState(n,0),this.setObjectMotionType(Module.MotionType.DYNAMIC,n,0),n}},{key:"removeAllObjects",value:function(){for(var t=this.getExistingObjectIDs(),e=0;e<t.size();e++){var n=t.get(e),i=this.getObjectFromScene(n);this.removeObject(n),this.sim.removeContactTestObject(i.objectHandle,0)}}},{key:"step",value:function(t){var e=this.sim.getAgent(this.selectedAgentId),n=this.getAgentTransformation(this.selectedAgentId);return!!this.isAgentColliding(t,n).collision||(e.act(t),!1)}},{key:"addAgent",value:function(t){var e=this.createAgentConfig(t);return this.resolution=this.flipVec2i(e.sensorSpecifications.get(0).resolution),this.sim.addAgent(e)}},{key:"addObject",value:function(t){return this.sim.addObject(t,null,"",0)}},{key:"removeObject",value:function(t){this.sim.removeObject(t,!0,!0,0)}},{key:"addObjectByHandle",value:function(t){return this.sim.addObjectByHandle(t,null,"",0)}},{key:"addPrimitiveObject",value:function(){var t=I(p.length),e=p[t],n=this.addObjectByHandle(e),i=this.getAgentTransformation(0).transformPoint(new Module.Vector3(.1,1.5,-1.5));return this.setTranslation(i,n,0),n}},{key:"addTemplateObject",value:function(){var t=I(f.objects.length),e=f.objects[t].objectHandle,n=this.addObjectByHandle(e),i=this.getAgentTransformation(0).transformPoint(new Module.Vector3(.1,1.5,-1.5));return this.setTranslation(i,n,0),this.addObjectInScene(n,f.objects[t]),this.sim.addContactTestObject(f.objects[t].objectHandle,0),n}},{key:"removeLastObject",value:function(){var t=this.getExistingObjectIDs();this.removeObject(t.get(t.size()-1))}},{key:"grabReleaseObject",value:function(){var t=this.getObjectUnderCrosshair(),e=this.getAgentTransformation(0);if(-1!=this.grippedObjectId){this.setTransformation(e.mul(this.gripOffset),this.grippedObjectId,0);var n=this.getTranslation(this.grippedObjectId,0);if(!this.pathfinder.isNavigable(this.convertVector3ToVec3f(n),.5))return void console.log("Colliding with object or position is not navigable");this.setObjectMotionType(Module.MotionType.STATIC,this.grippedObjectId,0),this.grippedObjectId=-1,this.drawBBAroundNearestObject()}else{if(-1==t)return;this.gripOffset=e.inverted().mul(this.getTransformation(t,0)),this.setObjectMotionType(Module.MotionType.KINEMATIC,t,0),this.grippedObjectId=t}this.recomputeNavMesh()}},{key:"inventoryGrabReleaseObject",value:function(){var t=this.getObjectUnderCrosshair().nearestObjectId,e=!1,n=!1,i={};if(-1!=this.grippedObjectId){n=!0;var s=this.getCrosshairPosition(),o=this.unproject(s).direction,r=this.getAgentTransformation(0),a=this.sim.findFloorPositionUnderCrosshair(o,r,this.resolution,this.maxDistance).point;if(null==a)return!0;var c=a.y();this.grippedObjectTransformation.translation().y()>=c&&(c=this.grippedObjectTransformation.translation().y());for(var l=new Module.Vector3(a.x(),c,a.z()),u=this.getObjectFromScene(this.grippedObjectId),h=this.isCollision(u.objectHandle,l),d=0;h&&d<4;)l=new Module.Vector3(l.x(),l.y()+.25,l.z()),h=this.isCollision(u.objectHandle,l),d+=1;var p=this.addObjectByHandle(u.objectHandle);this.setTranslation(l,p,0),this.setObjectMotionType(Module.MotionType.DYNAMIC,p,0),this.updateObjectInScene(this.grippedObjectId,p),i={newObjectTranslation:this.convertVector3ToVec3f(l),newObjectId:p,objectHandle:u.objectHandle,grippedObjectId:this.grippedObjectId},this.grippedObjectId=-1}else-1!=t&&(e=!0,this.grippedObjectTransformation=this.getTransformation(t,0),this.removeObject(t,0),this.grippedObjectId=t,i={grippedObjectId:this.grippedObjectId});return{grabAction:e,releaseAction:n,objectUnderCrosshair:t,grippedObjectId:this.grippedObjectId,nearestObjectId:this.nearestObjectId,actionMeta:i}}},{key:"getObservationSpace",value:function(t){return this.sim.getAgentObservationSpace(this.selectedAgentId,t)}},{key:"getObservation",value:function(t,e){return this.sim.getAgentObservation(this.selectedAgentId,t,e),e}},{key:"getPathFinder",value:function(){return this.sim.getPathFinder()}},{key:"getObjectMotionType",value:function(t,e){return this.sim.getObjectMotionType(t,e)}},{key:"setObjectMotionType",value:function(t,e,n){return this.sim.setObjectMotionType(t,e,n)}},{key:"getExistingObjectIDs",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.sim.getExistingObjectIDs(t)}},{key:"setTransformation",value:function(t,e,n){this.sim.setTransformation(t,e,n)}},{key:"getTransformation",value:function(t,e){return this.sim.getTransformation(t,e)}},{key:"getTranslation",value:function(t,e){return this.sim.getTranslation(t,e)}},{key:"setTranslation",value:function(t,e,n){this.sim.setTranslation(t,e,n)}},{key:"getRotation",value:function(t,e){return this.sim.getRotation(t,e)}},{key:"setRotation",value:function(t,e,n){this.sim.setRotation(t,e,n)}},{key:"setObjectBBDraw",value:function(t,e,n){this.sim.setObjectBBDraw(t,e,n)}},{key:"stepWorld",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/60;return this.sim.stepWorld(t)}},{key:"getWorldTime",value:function(){return this.sim.getWorldTime()}},{key:"displayObservation",value:function(t){this.sim.displayObservation(0,t)}},{key:"getSemanticScene",value:function(){return this.sim.getSemanticScene()}},{key:"getAgent",value:function(t){return this.sim.getAgent(t)}},{key:"getAgentTransformation",value:function(t){return this.sim.getAgentTransformation(t)}},{key:"getAgentAbsoluteTranslation",value:function(t){return this.sim.getAgentAbsoluteTranslation(t)}},{key:"getAgentState",value:function(){var t=new Module.AgentState;return this.sim.getAgent(this.selectedAgentId).getState(t),t}},{key:"getCrosshairPosition",value:function(){return this.resolution.map((function(t){return.5*t}))}},{key:"getObjectUnderCrosshair",value:function(){var t=this.getCrosshairPosition(),e=this.unproject(t).direction,n=this.getAgentAbsoluteTranslation(0);return{nearestObjectId:this.findNearestObjectUnderCrosshair(e,n,this.resolution),crossHairPoint:this.convertVector3ToVec3f(e),refPoint:this.convertVector3ToVec3f(n),crossHairPosition:t}}},{key:"drawBBAroundNearestObject",value:function(){var t=this.getObjectUnderCrosshair().nearestObjectId;-1==t?-1!=this.nearestObjectId&&this.grippedObjectId!=this.nearestObjectId&&(this.setObjectBBDraw(!1,this.nearestObjectId,0),this.nearestObjectId=t):(-1!=this.nearestObjectId&&this.grippedObjectId!=this.nearestObjectId&&(this.setObjectBBDraw(!1,this.nearestObjectId,0),this.nearestObjectId=-1),this.nearestObjectId!=t&&(this.nearestObjectId=t,this.setObjectBBDraw(!0,this.nearestObjectId,0)))}},{key:"sampleObjectState",value:function(t,e){this.sim.sampleObjectState(t,e)}},{key:"recomputeNavMesh",value:function(){var t=new Module.NavMeshSettings;this.sim.recomputeNavMesh(this.getPathFinder(),t,!0)}},{key:"toggleNavMeshVisualization",value:function(){this.sim.toggleNavMeshVisualization()}},{key:"findNearestObjectUnderCrosshair",value:function(t,e,n){return this.sim.findNearestObjectUnderCrosshair(t,e,n,this.maxDistance)}},{key:"unproject",value:function(t){return this.sim.unproject(t)}},{key:"isAgentColliding",value:function(t,e){if("moveForward"==t){var n=e.backward().mul(-.25),i=e.translation().add(n),s=this.pathfinder.tryStep(e.translation(),i).sub(i),o=i.add(s).add(new Module.Vector3(0,.05,0));return{collision:this.isCollision(this.agentObjectHandle,o,!0),position:o}}if("moveBackward"==t){var r=e.backward().mul(.25),a=e.translation().add(r),c=this.pathfinder.tryStep(e.translation(),a).sub(a),l=a.add(c).add(new Module.Vector3(0,.05,0));return{collision:this.isCollision(this.agentObjectHandle,l,!0),position:l}}return!1}},{key:"isCollision",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return this.sim.preAddContactTest(t,e,n,i)}},{key:"geodesicDistance",value:function(t,e){var n=new Module.ShortestPath;return n.requestedStart=t,n.requestedEnd=e,this.pathfinder.findPath(n),n.geodesicDistance}},{key:"getDistanceBetweenObjects",value:function(t,e){var n=this.getTranslation(t,0),i=this.getTranslation(e,0);return this.geodesicDistance(this.convertVector3ToVec3f(n),this.convertVector3ToVec3f(i))}},{key:"getObjectStates",value:function(){for(var t=[],e=this.getExistingObjectIDs(),n=0;n<e.size();n++){var i=e.get(n),s=this.getTranslation(i,0),o=this.getRotation(i,0),r=this.getObjectMotionType(i,0).value,a={objectId:i,translation:this.convertVector3ToVec3f(s),rotation:this.coeffFromQuat(o),motionType:r};t.push(a)}return t}},{key:"getAgentPose",value:function(){var t=this.getAgentTransformation(this.selectedAgentId);console.log("Agent pose:"),console.log(t.translation().toString()),console.log("\n")}},{key:"getObjectPose",value:function(){var t=this.getObjectUnderCrosshair().nearestObjectId,e=this.getTranslation(t,0),n=this.getRotation(t,0);console.log("object translation: "+this.convertVector3ToVec3f(e)),console.log("object rotation: "+this.coeffFromQuat(n))}},{key:"convertVector3ToVec3f",value:function(t){return[t.x(),t.y(),t.z()]}},{key:"convertVec3fToVector3",value:function(t){return new Module.Vector3(t[0],t[1],t[2])}},{key:"coeffFromQuat",value:function(t){var e=this.convertVector3ToVec3f(t.vector()).slice();return e.push(t.scalar()),e}},{key:"quatFromCoeffs",value:function(t){var e=this.convertVec3fToVector3(t.slice(0,3));return new Module.Quaternion(e,t[3])}},{key:"flipVec2i",value:function(t){return[t[1],t[0]]}},{key:"enableDebugDraw",value:function(){this.sim.enableDebugDraw()}},{key:"distanceToGoal",value:function(){if(0===Object.keys(this.episode).length||void 0===this.episode.goal)return[0,0];var t=this.episode.goal.position,e=this.getAgentState(),n=e.position,i=[t[0]-n[0],t[1]-n[1],t[2]-n[2]];return i=this.applyRotation(i,e.rotation),this.cartesian_to_polar(-i[2],i[0])}},{key:"applyRotation",value:function(t,e){var n,i,s,o,r,a,c,l=m()(t,3);n=l[0],i=l[1],s=l[2];var u=m()(e,4);o=u[0],r=u[1],a=u[2];var h=(c=u[3])*n-r*s+a*i,d=c*i-a*n+o*s,p=c*s-o*i+r*n,f=o*n+r*i+a*s,g=[];return g[0]=h*c+f*o+d*a-p*r,g[1]=d*c+f*r+p*o-h*a,g[2]=p*c+f*a+h*r-d*o,g}},{key:"cartesian_to_polar",value:function(t,e){return[Math.sqrt(t*t+e*e),Math.atan2(e,t)]}},{key:"createSensorSpec",value:function(t){var e=new Module.SensorSpec;for(var n in t){var i=t[n];e[n]=i}return e}},{key:"createAgentConfig",value:function(t){var e=new Module.AgentConfiguration;for(var n in t){var i=t[n];if("sensorSpecifications"===n){var s,o=new Module.VectorSensorSpec,r=P(i);try{for(r.s();!(s=r.n()).done;){var a=s.value;o.push_back(this.createSensorSpec(a))}}catch(t){r.e(t)}finally{r.f()}i=o}e[n]=i}return e}},{key:"createAgentState",value:function(t){var e=new Module.AgentState;for(var n in t){var i=t[n];e[n]=i}return e}}]),t}(),R=function(){function t(e,n){s()(this,t),this.pathFinder=e,this.bounds=e.bounds,this.canvas=n,this.ctx=n.getContext("2d"),this.widthComponent=0,this.heightComponent=2,this.scale=1,this.ctx.strokeStyle="blue",this.ctx.lineWidth=3,this.currentY=-1/0}return r()(t,[{key:"draw",value:function(){var t=this.ctx,e=this.canvas,n=this.mapCenterInset(),i=m()(n,2),s=i[0],o=i[1];t.clearRect(0,0,e.width,e.height),t.putImageData(this.imageData,s,o)}},{key:"start",value:function(t){this.currentY=t[1],this.imageData=this.createMap(),this.draw();var e=this.convertPosition(t),n=m()(e,2),i=n[0],s=n[1];this.ctx.beginPath(),this.ctx.moveTo(i,s)}},{key:"moveTo",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0!==e)this.throttledMoveTo||(this.throttledMoveTo=O(this.moveTo.bind(this),e)),this.throttledMoveTo(t);else if(t[1]<this.currentY-.25||t[1]>this.currentY+.25)this.start(t);else{var n=this.convertPosition(t),i=m()(n,2),s=i[0],o=i[1];this.ctx.lineTo(s,o),this.ctx.stroke()}}},{key:"mapCenterInset",value:function(){return[(this.canvas.width-this.imageData.width)/2,(this.canvas.height-this.imageData.height)/2]}},{key:"convertPosition",value:function(t){var e=this.widthComponent,n=this.heightComponent,i=this.mapCenterInset(),s=m()(i,2),o=s[0],r=s[1];return[o+=(t[e]-this.bounds.min[e])*this.scale,r+=(t[n]-this.bounds.min[n])*this.scale]}},{key:"createMap",value:function(){var t=this.canvas,e=this.bounds.max[0]-this.bounds.min[0],n=this.bounds.max[2]-this.bounds.min[2],i=0,s=0;if(e>n&&t.width<t.height||e<n&&t.width>t.height){this.widthComponent=2,this.heightComponent=0;var o=e;e=n,n=o}n/e>t.height/t.width?(this.scale=t.height/n,i=t.height,s=Math.round(e*this.scale-.5)):(this.scale=t.width/e,s=t.width,i=Math.round(n*this.scale-.5));var r,a,c=new ImageData(s,i),l=4*t.width,u=1/this.scale,h=this.bounds.min[this.heightComponent]+u/2;for(r=0;r<i;r++){var d=this.bounds.min[this.widthComponent]+u/2;for(a=0;a<s;a++){var p=[0,this.currentY,0];p[this.widthComponent]=d,p[this.heightComponent]=h,this.pathFinder.isNavigable(p,.5)&&(c.data[r*l+4*a]=255,c.data[r*l+4*a+1]=255,c.data[r*l+4*a+2]=255,c.data[r*l+4*a+3]=255),d+=u}h+=u}return c}}]),t}(),E=function(){function t(e,n,i,o){s()(this,t),this.rect=e,this.semanticShape=n,this.semanticScene=i,this.objectIds=[];for(var r=this.semanticScene.categories,a=this.semanticScene.objects,c=-1,l=0;l<r.size();l++){var u=r.get(l);if(u&&u.getName("")===o){c=u.getIndex("");break}}for(var h=0;h<a.size();h++){var d=a.get(h)||{};d.category&&d.category.getIndex("")===c&&this.objectIds.push(h)}}return r()(t,[{key:"computeIOU",value:function(t){for(var e=this.semanticShape.get(1),n=this.semanticShape.get(0),i=this.rect.left,s=this.rect.top,o=this.rect.right,r=this.rect.bottom,a=0,c=0,l=!1,u=0;u<n;u++){l=u>=s&&u<r;for(var h=0;h<e;h++)this.objectIds.includes(t[u*e+h])&&(l&&h>=i&&h<o?a++:c++)}return 0===a?0:a/(c+(r-s)*(o-i))}}]),t}(),F=function(){function t(e){s()(this,t),this.inventorySlots=e,this.inventory=new Array(e),this.inventoryComponent=null,this.inventoryEnabled=!1,this.inventoryCtx=null}return r()(t,[{key:"reset",value:function(){this.inventory=new Array(this.inventorySlots)}},{key:"initInventory",value:function(t){this.inventoryComponent=t,this.inventoryEnabled=!0,this.inventoryCtx=t.getContext("2d")}},{key:"setSlot",value:function(t,e){this.inventory[t]=e}},{key:"getSlot",value:function(t){return this.inventory[t]}},{key:"getEmptySlot",value:function(){for(var t=0;t<this.inventorySlots;t++)if(void 0===this.inventory[t])return t;return-1}},{key:"findObjectSlot",value:function(t){for(var e=0;e<this.inventorySlots;e++)if(void 0!==this.inventory[e]&&this.inventory[e].objectId===t)return e;return-1}},{key:"renderInventory",value:function(){var t=this;if(this.inventoryEnabled){var e=80*this.inventorySlots;""===this.inventoryComponent.style.border&&(this.inventoryComponent.style.border="5px solid #000000",this.inventoryComponent.width=e.toString());var n=this.inventoryCtx;n.clearRect(0,0,e,80),n.fillStyle="darkslategray";for(var i=function(e){var i=2+78*e;n.beginPath(),n.strokeStyle="grey",n.lineWidth=5,n.rect(i,2,76,76),n.stroke(),n.closePath();if(void 0!==t.inventory[e]){var s=new Image;s.src=t.inventory[e].objectIcon,s.addEventListener("load",(function(){n.drawImage(s,i+2,4,72,72)}))}},s=0;s<this.inventorySlots;++s)i(s)}}}]),t}(),V=function(){function t(e,n){s()(this,t),this.episode=e,this.sim=n,this.task=this.episode.task}return r()(t,[{key:"validate",value:function(){return void 0===this.task||("arrangement"===this.task.type?this.validateArrangementTask():"stacking"===this.task.type?this.validateStackingTask():void 0)}},{key:"validateArrangementTask",value:function(){var t=this.task.goals;if(void 0===t||void 0===t.objectToReceptacleMap)return!0;var e=t.objectToReceptacleMap,n=this.sim.getObjectsInScene();for(var i in e){for(var s=n[parseInt(i)].objectId,o=e[i],r=!1,a=0;a<o.length;a++){var c=n[o[a]].objectId;this.sim.getDistanceBetweenObjects(s,c)<=.8&&(r=!0)}if(!r)return!1}return!0}},{key:"validateStackingTask",value:function(){}}]),t}();function H(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"==typeof t)return B(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return B(t,e)}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,r=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return r=t.done,t},e:function(t){a=!0,o=t},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw o}}}}function B(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}var L=function(){function t(e,n){var i=this;if(s()(this,t),this.sim=e,this.components=n,this.topdown=n.topdown,this.semanticsEnabled=!1,this.radarEnabled=!1,this.keyBindListener=null,this.lastInteractedObjectId=-1,this.inventory=new F(1),this.taskValidator=null,this.components.semantic){if(this.semanticsEnabled=!0,this.semanticCtx=n.semantic.getContext("2d"),this.semanticShape=this.sim.getObservationSpace("semantic").shape,this.semanticImageData=this.semanticCtx.createImageData(this.semanticShape.get(1),this.semanticShape.get(0)),this.semanticObservation=new Module.Observation,this.semanticScene=this.sim.sim.getSemanticScene(),this.semanticObjects=this.semanticScene.objects,window.config.category){var o=this.components.scope.offsetWidth,r=this.components.scope.offsetHeight,a=(this.components.canvas.width-o)/2,c=(this.components.canvas.height-r)/2,l={left:a,top:c,right:a+o,bottom:c+r};this.objectSensor=new E(l,this.semanticShape,this.semanticScene,window.config.category)}n.canvas.onmousedown=function(t){i.handleMouseDown(t)}}this.components.radar&&(this.radarEnabled=!0,this.radarCtx=n.radar.getContext("2d")),this.components.inventory&&this.inventory.initInventory(n.inventory),this.components.taskValidator&&(this.taskValidator=this.components.taskValidator),this.psiturk=new A(window.psiTurk),this.actions=[{name:"moveForward",key:"w",keyCode:87},{name:"moveBackward",key:"s",keyCode:83},{name:"turnLeft",key:"ArrowLeft",keyCode:37},{name:"turnRight",key:"ArrowRight",keyCode:39},{name:"turnLeft",key:"a",keyCode:65},{name:"turnRight",key:"d",keyCode:68},{name:"lookUp",key:"ArrowUp",keyCode:38},{name:"lookDown",key:"ArrowDown",keyCode:40},{name:"grabReleaseObject",key:" ",keyCode:32}]}return r()(t,[{key:"handleMouseDown",value:function(t){var e=this.semanticShape.get(0),n=this.semanticShape.get(1),i=e-1-t.offsetY,s=t.offsetX,o=this.semanticData[n*i+s];this.setStatus(this.semanticObjects.get(o).category.getName(""))}},{key:"init",value:function(){this.bindKeys(),this.psiturk.handleRecordTrialData("TEST","simInitialized",{config:window.config}),this.initialized=!0,this.initPhysics()}},{key:"initPhysics",value:function(){var t=this;Module.enablePhysics&&!0!==window.config.runFlythrough&&!0===window.config.enableStepPhysics&&(console.log("enabled physics step at 100ms interval"),this.physicsStepFunction=setInterval((function(){var e=(new Date).getTime();t.sim.stepWorld(.1),t.render();var n=t.sim.getObjectStates(),i=t.sim.getObjectUnderCrosshair().nearestObjectId;t.psiturk.handleRecordTrialData("TEST","stepPhysics",{step:.1,objectStates:n,objectUnderCrosshair:i,totalTime:(new Date).getTime()-e})}),100))}},{key:"disablePhysics",value:function(){this.physicsStepFunction&&(console.log("clearing physics interval on reset"),window.clearInterval(this.physicsStepFunction))}},{key:"reset",value:function(){this.lastInteractedObjectId=-1,this.disablePhysics(),this.sim.reset(),this.inventory.reset(),this.inventory.renderInventory(),this.setStatus("Ready"),this.initPhysics(),this.render()}},{key:"runFlythrough",value:function(t){var e=this;this.setStatus("Initializing...");var n=this;this.psiturk.handleRecordTrialData("TEST","flythroughStart",{});var i=!!this.keyBindListener;this.unbindKeys();var s=FS.readFile("/data/".concat(t),{encoding:"utf8"}).split(/\r?\n/),o=null,r=0,a=!1;this.replayTimeouts=[];for(var c=function(t){var i=s[t];if(0===i.length)return"continue";var c=i.split(","),l=c.slice(0,3)[2],u=c.slice(3).join(",");'"'==u[0]&&'"'==u[u.length-1]&&(u=function(t,e,n){for(;-1!==t.indexOf(e);)t=t.replace(e,n);return t}(u=u.slice(1,u.length-1),'""','"'));var h=JSON.parse(u);if(!1===a){if("viewer"!==h.step)return"continue";a=!0}o||(o=l);var d=(l-o)/1,p=window.setTimeout((function(){"simReset"===h.event?n.reset():"handleAction"==h.event?n.handleAction(h.data.action):"stepPhysics"==h.event&&(n.sim.stepWorld(.1),n.render())}),d);e.replayTimeouts.push(p),r=d},l=0;l<s.length;++l)c(l);this.clearTimeouts=function(){if(this.clearTimeouts=null,this.replayTimeouts){for(var t=0;t<this.replayTimeouts.length;++t){var e=this.replayTimeouts[t];window.clearTimeout(e)}delete this.replayTimeouts}i&&n.bindKeys(),n.setStatus("")};var u=window.setTimeout((function(){"function"==typeof this.clearTimeouts&&this.clearTimeouts(),window.finishTrial()}),r+1);this.replayTimeouts.push(u),this.psiturk.handleRecordTrialData("TEST","flythroughEnd",{})}},{key:"setTaskValidator",value:function(t){this.taskValidator=new V(t,this.sim)}},{key:"setStatus",value:function(t){this.components.status.style="color:white",this.components.status.innerHTML=t}},{key:"setErrorStatus",value:function(t){this.components.status.style="color:red",this.components.status.innerHTML=t}},{key:"setWarningStatus",value:function(t){this.components.status.style="color:orange",this.components.status.innerHTML=t}},{key:"setSuccessStatus",value:function(t){this.components.status.style="color:green",this.components.status.innerHTML=t}},{key:"renderImage",value:function(){this.sim.displayObservation("rgb"),this.renderRadar()}},{key:"renderSemanticImage",value:function(){if(this.semanticsEnabled&&0!=this.semanticObjects.size()){this.sim.getObservation("semantic",this.semanticObservation);var t=this.semanticObservation.getData(),e=new Uint32Array(t.buffer,t.byteOffset,t.length/4);this.semanticData=e;for(var n=0;n<e.length;n++){var i=e[n];this.semanticImageData.data[4*n]=1&i?255:0,this.semanticImageData.data[4*n+1]=2&i?255:0,this.semanticImageData.data[4*n+2]=4&i?255:0,this.semanticImageData.data[4*n+3]=255}this.semanticCtx.putImageData(this.semanticImageData,0,0)}}},{key:"renderTopDown",value:function(t){t.renderTopDown&&null!==this.topdown&&this.topdown.moveTo(this.sim.getAgentState().position,500)}},{key:"renderRadar",value:function(){if(this.radarEnabled){var t,e,n=this.radarCtx;n.clearRect(0,0,100,100),n.globalAlpha=.5,n.fillStyle="darkslategray",n.arc(50,50,50,0,2*Math.PI),n.fill(),n.fillStyle="darkgray",n.beginPath(),n.arc(50,50,50,3*-Math.PI/4,-Math.PI/4),n.lineTo(50,50),n.closePath(),n.fill(),n.globalAlpha=1,n.beginPath();var i=this.sim.distanceToGoal(),s=m()(i,2);t=s[0],e=s[1];var o=t/(t+1),r=50+50*Math.sin(e)*o,a=50-50*Math.cos(e)*o;n.fillStyle="maroon",n.arc(r,a,3,0,2*Math.PI),n.fill()}}},{key:"render",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{renderTopDown:!0};this.renderImage(),this.sim.updateCrossHairNode(this.sim.getCrosshairPosition()),this.sim.drawBBAroundNearestObject(),this.renderImage(),this.renderSemanticImage(),this.renderTopDown(t)}},{key:"handleInventoryUpdate",value:function(t){var e=this.sim.grippedObjectId;if(t)this.setStatus("Collision while releasing object!");else{if(-1==e){var n=this.inventory.findObjectSlot(this.lastInteractedObjectId);if(-1!=n&&this.inventory.setSlot(n,void 0),-1!=this.lastInteractedObjectId){var i=this.sim.getObjectFromScene(this.lastInteractedObjectId);this.setStatus(i.object+" released")}}else{var s=this.inventory.getEmptySlot(),o=this.sim.getObjectFromScene(e);-1==s?console.log("No empty slot in inventory!"):(this.inventory.setSlot(s,{objectId:e,object:o.object,objectIcon:o.objectIcon}),this.setStatus(o.object+" picked up"))}this.lastInteractedObjectId=e}}},{key:"validateTask",value:function(){return!window.config.runFlythrough&&this.taskValidator.validate()}},{key:"handleAction",value:function(t){var e={},n=!1;if("addPrimitiveObject"===t)this.sim.addPrimitiveObject();else if("addTemplateObject"===t)this.sim.addTemplateObject();else if("removeLastObject"===t)this.sim.removeLastObject();else if("grabReleaseObject"==t){var i=this.sim.inventoryGrabReleaseObject();this.handleInventoryUpdate(i.collision),this.inventory.renderInventory(),-1===this.sim.grippedObjectId&&this.validateTask()&&window.finishTrial&&(this.setStatus("Task completed!"),setTimeout(window.finishTrial,500)),e=i}else"getObjectPose"==t?this.sim.getObjectPose():"getAgentPose"==t?this.sim.getAgentPose():(n=this.sim.step(t),this.setStatus(t));var s=this.sim.getObjectUnderCrosshair().nearestObjectId;this.psiturk.handleRecordTrialData("TEST","handleAction",{action:t,actionData:e,collision:n,objectUnderCrosshair:s,nearestObjectId:this.sim.nearestObjectId,grippedObjectId:this.sim.grippedObjectId}),this.render()}},{key:"handleKeypress",value:function(t){var e,n=H(this.actions);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(i.keyCode===t){this.handleAction(i.name);break}}}catch(t){n.e(t)}finally{n.f()}}},{key:"bindKeys",value:function(){var t=this;t.keyBindListener?console.log("Keys already bound. Returning"):(t.keyBindListener=function(e){e.preventDefault(),t.handleKeypress(e.keyCode)},document.addEventListener("keydown",t.keyBindListener,!0))}},{key:"unbindKeys",value:function(){this.keyBindListener&&(document.removeEventListener("keydown",this.keyBindListener,!0),this.keyBindListener=null)}}]),t}();function N(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function U(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?N(Object(n),!0).forEach((function(e){c()(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):N(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var z=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"canvas";s()(this,t),c()(this,"currentResolution",h),this.canvasId=e}return r()(t,[{key:"initializeModules",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.sceneConfig=new Module.SceneConfiguration,this.sceneConfig.id=Module.scene,this.config=new Module.SimulatorConfiguration,this.config.scene=this.sceneConfig,this.config.enablePhysics=Module.enablePhysics,this.config.physicsConfigFile=Module.physicsConfigFile,this.simenv=new D(this.config,e,0),t=this.updateAgentConfigWithSensors(U({},t)),this.simenv.addAgent(t),this.simenv.updateCrossHairNode(this.simenv.resolution),this.topdown=n?new R(this.simenv.getPathFinder(),document.getElementById("topdown")):null,this.canvasElement=document.getElementById(this.canvasId),this.taskValidator=new V(e,this.simenv),this.task=new L(this.simenv,{topdown:this.topdown,canvas:this.canvasElement,inventory:document.getElementById("inventory"),semantic:document.getElementById("semantic"),radar:document.getElementById("radar"),scope:document.getElementById("scope"),status:document.getElementById("status"),taskValidator:this.taskValidator})}},{key:"setEpisode",value:function(t){var e=document.getElementById("task-instruction"),n=document.getElementById("text-assistance-1");if(null!=e&&(e.innerHTML="<hr> <h1>Task: "+t.task.instruction+"</h1> <hr>"),null!=n){var i=function(t){for(var e=t.objects,n={objects:[],receptacles:[]},i=0;i<e.length;i++){var s=e[i],o=s.object,r="<div><img src='"+s.objectIcon+"' style='border: 3px solid grey'/><div class='img-caption'>"+o+"</div></div>";s.isReceptacle?n.receptacles.push(r):n.objects.push(r)}return n}(t);n.innerHTML="<div class='object-type'> Objects: </div> <ul>"+i.objects.join("\n")+"</ul><br/><div class='object-type'> Receptacles: </div> <ul>"+i.receptacles.join("\n")+"</ul>"}this.simenv.setEpisode(t)}},{key:"setTaskValidator",value:function(t){this.task.setTaskValidator(t)}},{key:"runFlythrough",value:function(){window.config.disableLogging=!0,window.config.runFlythrough=!0,window.config.enableStepPhysics=!1;var t=window.config.taskConfig.flythroughTask.name,e=window.config.taskConfig.flythroughReplayFile.name,n=M("/data/".concat(t));this.setEpisode(n),this.setTaskValidator(n),this.task.reset(),this.task.runFlythrough(e)}},{key:"runInit",value:function(){window.config.disableLogging=!1,window.config.runFlythrough=!1,window.config.enableStepPhysics=!0;var t=window.config.episodeId,e=M("/data/".concat(window.config.taskConfig.name),t);this.setEpisode(e),this.setTaskValidator(e),this.task.reset()}},{key:"runTrainingTask",value:function(){window.config.disableLogging=!0,window.config.runFlythrough=!1,window.config.enableStepPhysics=!0;var t=window.config.taskConfig.trainingTask.name,e=M("/data/".concat(t));this.setEpisode(e),this.setTaskValidator(e),this.task.reset()}},{key:"updateAgentConfigWithSensors",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l,e=[{uuid:"rgb",sensorType:Module.SensorType.COLOR,resolution:[480,640]},{uuid:"semantic",sensorType:Module.SensorType.SEMANTIC,resolution:[480,640],channels:1}];return t.sensorSpecifications=e,t=this.updateAgentConfigWithResolution(t)}},{key:"resetCanvas",value:function(t){this.canvasElement.width=t.width,this.canvasElement.height=t.height}},{key:"updateAgentConfigWithResolution",value:function(t){var e=this;return t.sensorSpecifications.forEach((function(t){t.resolution=[e.currentResolution.height,e.currentResolution.width]})),t}},{key:"display",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=S();n.useDefaultEpisode&&(e=u),this.initializeModules(t,e),this.task.init(),this.task.reset()}},{key:"validateTask",value:function(){this.task.validateTask()}}]),t}(),W=n(2),K=n.n(W),G=n(6),Y=n.n(G),q=n(7),J=n.n(q),Q=n(8),$=n.n(Q),X=n(5),Z=n.n(X);function tt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=Z()(t);if(e){var s=Z()(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return $()(this,n)}}var et=function(t){J()(n,t);var e=tt(n);function n(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"canvas",o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"fps";return s()(this,n),t=e.call(this),c()(K()(t),"normalSceneFrame",void 0),c()(K()(t),"vrSceneFrame",void 0),c()(K()(t),"fpsElement",void 0),c()(K()(t),"lastPaintTime",void 0),c()(K()(t),"frameData",new VRFrameData),c()(K()(t),"previousRotation",!1),c()(K()(t),"previousPosition",!1),c()(K()(t),"currentVrDisplay",!1),c()(K()(t),"fps",0),c()(K()(t),"skipFrames",60),c()(K()(t),"currentFramesSkipped",0),t.canvasElement=document.getElementById(i),t.fpsElement=document.getElementById(o),t}return r()(n,[{key:"display",value:function(){this.setUpVR()}},{key:"initializeModules",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:u,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Y()(Z()(n.prototype),"initializeModules",this).call(this,t,e,i)}},{key:"setUpVR",value:function(){var t=this;navigator.getVRDisplays().then((function(e){e.length>0?t.setupDisplay(e[0]):(console.log("VR display not supported by this device"),Y()(Z()(n.prototype),"display",t).call(t))}))}},{key:"setupDisplay",value:function(t){var e=this;this.currentVrDisplay=t,this.currentVrDisplay.requestPresent([{source:this.canvasElement}]).then((function(){return e.setupCanvas()})).then((function(){return e.initializeModules()})).then((function(){return e.renderDisplay()}))}},{key:"renderDisplay",value:function(){this.task.reset(),this.drawVRScene()}},{key:"setupCanvas",value:function(){var t=this.currentVrDisplay.getEyeParameters("left"),e=this.currentVrDisplay.getEyeParameters("right"),n=2*Math.max(t.renderWidth,e.renderWidth),i=Math.max(t.renderHeight,e.renderHeight);this.currentResolution={height:i,width:n},this.resetCanvas(this.currentResolution)}},{key:"drawVRScene",value:function(){this.vrSceneFrame=this.currentVrDisplay.requestAnimationFrame(this.drawVRScene.bind(this)),this.currentVrDisplay.getFrameData(this.frameData),this.updateAgentState(),this.task.render({renderTopDown:!1}),this.currentVrDisplay.submitFrame(),this.updateFPS()}},{key:"updateAgentState",value:function(){var t=this,e=this.simenv.sim.getAgent(this.simenv.selectedAgentId),n=this.simenv.createAgentState({});e.getState(n);var i=n.rotation.slice(),s=n.position.slice();if(this.previousRotation){var o=this.frameData.pose.orientation,r=this.frameData.pose.position;o.forEach((function(e,n){i[n]+=e-t.previousRotation[n]})),r.forEach((function(e,n){s[n]+=e-t.previousPosition[n]})),this.previousRotation=o.slice(),this.previousPosition=r.slice()}else this.previousRotation=this.frameData.pose.orientation.slice(),this.previousPosition=this.frameData.pose.position.slice();var a={position:s,rotation:i};a=this.simenv.createAgentState(a),e.setState(a,!0)}},{key:"updateFPS",value:function(){if(this.currentFramesSkipped==this.skipFrames)if(this.currentFramesSkipped=0,this.lastPaintTime){var t=performance.now(),e=(t-this.lastPaintTime)/1e3;this.fps=this.skipFrames/e,this.lastPaintTime=t,this.fpsElement.innerHTML="FPS: ".concat(this.fps.toFixed(2))}else this.lastPaintTime=performance.now();else this.currentFramesSkipped++}}]),n}(z);n(19);function nt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=Z()(t);if(e){var s=Z()(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return $()(this,n)}}var it=function(t){J()(n,t);var e=nt(n);function n(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"canvas";return s()(this,n),(t=e.call(this,i)).canvasElement=document.getElementById(i),window.addEventListener("resize",t.windowResizeEvent.bind(K()(t))),t}return r()(n,[{key:"initializeModules",value:function(){for(var t,e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];3===i.length?i[2]=!1:2==i.length&&i.push(!1),(t=Y()(Z()(n.prototype),"initializeModules",this)).call.apply(t,[this].concat(i))}},{key:"resetCanvasToCurrent",value:function(){this.currentResolution={height:this.canvasElement.offsetHeight,width:this.canvasElement.offsetWidth},this.resetCanvas(this.currentResolution)}},{key:"display",value:function(){this.resetCanvasToCurrent(),Y()(Z()(n.prototype),"display",this).call(this)}},{key:"windowResizeEvent",value:function(){}}]),n}(z);n(21);function st(t){var e=t;if(0===t.indexOf("http")){var n=t.split("/");e=n[n.length-1]}return FS.createPreloadedFile("/",e,"data/scenes/".concat(t),!0,!1),e}function ot(t,e){FS.createPreloadedFile("/data",t.name,"data/".concat(t.config),!0,!1),FS.createPreloadedFile("/data",e.name,"data/".concat(e.location),!0,!1)}Module.preRun.push((function(){var t={};t.scene=d,S(t),window.config=t;var e=b.tasks[parseInt(window.config.task)];window.config.taskConfig=e,void 0!==e&&(t.scene=e.scene,window.config.scene=e.scene);var n=t.scene;Module.scene=st(n);var i=window.config.defaultPhysConfig;Module.physicsConfigFile=function(t){FS.mkdir("/data");var e=t;if(0===t.indexOf("http")){var n=t.split("/");e=n[n.length-1]}FS.createPreloadedFile("/data",e,"data/".concat(t),!0,!1);var i="/data".concat("/objects");FS.mkdir(i);var s=f.objects;for(var o in s){var r=s[o].physicsProperties,a=r.split("/")[r.split("/").length-1],c=s[o].renderMesh,l=c.split("/")[c.split("/").length-1];FS.createPreloadedFile(i,l,"data/".concat(c),!0,!1),FS.createPreloadedFile(i,a,"data/".concat(r),!0,!1)}return"/data".concat("/".concat(e))}(i),Module.enablePhysics="true"===window.config.enablePhysics,window.config.runFlythrough="true"===window.config.runFlythrough,window.config.enableStepPhysics="true"===window.config.enableStepPhysics,function(t){if(void 0!==t){var e=t.name,n=t.config;FS.createPreloadedFile("/data",e,"data/".concat(n),!0,!1),FS.createPreloadedFile("/data",t.trainingTask.name,"data/".concat(t.trainingTask.config),!0,!1)}}(e),null!=e?ot(e.flythroughTask,e.flythroughReplayFile):ot(g,v);var s=n.substr(0,n.lastIndexOf("."));window.config.recomputeNavMesh||st(s+".navmesh"),"mp3d"===t.semantic?(st(s+".house"),st(s+"_semantic.ply")):"replica"===t.semantic&&st(function(t){var e=t.split("/"),n=e.length>1;e.pop();var i="info_semantic.json";return n&&(i="/"+i),e.join("/")+i}(t.scene))})),Module.onRuntimeInitialized=function(){var t;if(console.log("hsim_bindings initialized"),window.vrEnabled?navigator&&navigator.getVRDisplays&&(console.log("Web VR is supported"),t=new et):window.viewerEnabled&&(t=new it),t||(t=new z),void 0!==window.config.taskConfig){var e=M("/data/".concat(window.config.taskConfig.name),window.config.episodeId);t.display(void 0,e)}else t.display();!0===window.config.runFlythrough&&t.runFlythrough(),window.demo=t},function(){var t=function(){var t,e,n=!1;try{e=(t=document.createElement("canvas")).getContext("webgl")||t.getContext("experimental-webgl")}catch(t){return}return void 0!==e&&(n=!0),t=void 0,n?2:"undefined"!=typeof WebGL2RenderingContext?1:0}(),e="";if(t?1===t&&(e="WebGL2 is supported on your browser, but not enabled. "):e="WebGL2 is not supported on your browser. ",function(){try{if("object"===("undefined"==typeof WebAssembly?"undefined":k()(WebAssembly))&&"function"==typeof WebAssembly.instantiate){var t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){return!1}return!1}()||(e+="Web Assembly is not supported in your browser"),e.length>0){var n=document.getElementById("warning");n.innerHTML=e,n.className=""}}()}]);
//# sourceMappingURL=bundle.js.map