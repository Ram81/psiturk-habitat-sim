!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=23)}([function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e){function n(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}t.exports=function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}},function(t,e){t.exports=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}},function(t,e){t.exports=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}},function(t,e,n){var i=n(12),o=n(13),s=n(14),r=n(16);t.exports=function(t,e){return i(t)||o(t,e)||s(t,e)||r()}},function(t,e){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},n(e)}t.exports=n},function(t,e,n){var i=n(17);function o(e,n,s){return"undefined"!=typeof Reflect&&Reflect.get?t.exports=o=Reflect.get:t.exports=o=function(t,e,n){var o=i(t,e);if(o){var s=Object.getOwnPropertyDescriptor(o,e);return s.get?s.get.call(n):s.value}},o(e,n,s||e)}t.exports=o},function(t,e,n){var i=n(18);t.exports=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&i(t,e)}},function(t,e,n){var i=n(9),o=n(2);t.exports=function(t,e){return!e||"object"!==i(e)&&"function"!=typeof e?o(t):e}},function(t,e){function n(e){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=n=function(t){return typeof t}:t.exports=n=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(e)}t.exports=n},function(t,e,n){"use strict";var i,o=function(){return void 0===i&&(i=Boolean(window&&document&&document.all&&!window.atob)),i},s=function(){var t={};return function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}t[e]=n}return t[e]}}(),r=[];function a(t){for(var e=-1,n=0;n<r.length;n++)if(r[n].identifier===t){e=n;break}return e}function c(t,e){for(var n={},i=[],o=0;o<t.length;o++){var s=t[o],c=e.base?s[0]+e.base:s[0],u=n[c]||0,l="".concat(c," ").concat(u);n[c]=u+1;var h=a(l),d={css:s[1],media:s[2],sourceMap:s[3]};-1!==h?(r[h].references++,r[h].updater(d)):r.push({identifier:l,updater:g(d,e),references:1}),i.push(l)}return i}function u(t){var e=document.createElement("style"),i=t.attributes||{};if(void 0===i.nonce){var o=n.nc;o&&(i.nonce=o)}if(Object.keys(i).forEach((function(t){e.setAttribute(t,i[t])})),"function"==typeof t.insert)t.insert(e);else{var r=s(t.insert||"head");if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(e)}return e}var l,h=(l=[],function(t,e){return l[t]=e,l.filter(Boolean).join("\n")});function d(t,e,n,i){var o=n?"":i.media?"@media ".concat(i.media," {").concat(i.css,"}"):i.css;if(t.styleSheet)t.styleSheet.cssText=h(e,o);else{var s=document.createTextNode(o),r=t.childNodes;r[e]&&t.removeChild(r[e]),r.length?t.insertBefore(s,r[e]):t.appendChild(s)}}function f(t,e,n){var i=n.css,o=n.media,s=n.sourceMap;if(o?t.setAttribute("media",o):t.removeAttribute("media"),s&&btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleSheet)t.styleSheet.cssText=i;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(i))}}var p=null,v=0;function g(t,e){var n,i,o;if(e.singleton){var s=v++;n=p||(p=u(e)),i=d.bind(null,n,s,!1),o=d.bind(null,n,s,!0)}else n=u(e),i=f.bind(null,n,e),o=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(n)};return i(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;i(t=e)}else o()}}t.exports=function(t,e){(e=e||{}).singleton||"boolean"==typeof e.singleton||(e.singleton=o());var n=c(t=t||[],e);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var i=0;i<n.length;i++){var o=a(n[i]);r[o].references--}for(var s=c(t,e),u=0;u<n.length;u++){var l=a(n[u]);0===r[l].references&&(r[l].updater(),r.splice(l,1))}n=s}}}},function(t,e,n){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var n=function(t,e){var n=t[1]||"",i=t[3];if(!i)return n;if(e&&"function"==typeof btoa){var o=(r=i,a=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),"/*# ".concat(c," */")),s=i.sources.map((function(t){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(t," */")}));return[n].concat(s).concat([o]).join("\n")}var r,a,c;return[n].join("\n")}(e,t);return e[2]?"@media ".concat(e[2]," {").concat(n,"}"):n})).join("")},e.i=function(t,n,i){"string"==typeof t&&(t=[[null,t,""]]);var o={};if(i)for(var s=0;s<this.length;s++){var r=this[s][0];null!=r&&(o[r]=!0)}for(var a=0;a<t.length;a++){var c=[].concat(t[a]);i&&o[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),e.push(c))}},e}},function(t,e){t.exports=function(t){if(Array.isArray(t))return t}},function(t,e){t.exports=function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var n=[],i=!0,o=!1,s=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done)&&(n.push(r.value),!e||n.length!==e);i=!0);}catch(t){o=!0,s=t}finally{try{i||null==a.return||a.return()}finally{if(o)throw s}}return n}}},function(t,e,n){var i=n(15);t.exports=function(t,e){if(t){if("string"==typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(t,e):void 0}}},function(t,e){t.exports=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(t,e,n){var i=n(5);t.exports=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=i(t)););return t}},function(t,e){function n(e,i){return t.exports=n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},n(e,i)}t.exports=n},function(t,e,n){var i=n(10),o=n(20);"string"==typeof(o=o.__esModule?o.default:o)&&(o=[[t.i,o,""]]);var s={insert:"head",singleton:!1};i(o,s);t.exports=o.locals||{}},function(t,e,n){(e=n(11)(!1)).push([t.i,".viewer-canvas {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  right: 0;\n  left: 0;\n  overflow: hidden;\n}\n\n.hidden {\n  display: hidden;\n}\n\n.tooltip {\n  color: #fff;\n  background-color: #666;\n  line-height: 2;\n  border-radius: 2px;\n  top: 0;\n  padding-top: 3px;\n  padding-bottom: 3px;\n  position: absolute;\n  z-index: 100;\n  text-align: center;\n  width: 100%;\n}\n\n.mobile-warning {\n  position: absolute;\n  bottom: 5px;\n}\n",""]),t.exports=e},function(t,e,n){var i=n(10),o=n(22);"string"==typeof(o=o.__esModule?o.default:o)&&(o=[[t.i,o,""]]);var s={insert:"head",singleton:!1};i(o,s);t.exports=o.locals||{}},function(t,e,n){(e=n(11)(!1)).push([t.i,"/** Copyright (c) Facebook, Inc. and its affiliates.\n *  This source code is licensed under the MIT license found in the\n *  LICENSE file in the root directory of this source tree.\n */\n#radar {\n  position: absolute;\n  top: 70%;\n  left: 50%;\n  margin-left: -50px;\n  width: 100;\n  height: 100;\n  z-index: 9;\n  pointer-events: none;\n  visibility: hidden;\n}\n\n#scope {\n  position: absolute;\n  border-color: red;\n  border-style: dashed;\n  border-width: 5px;\n  opacity: 0.4;\n  top: 50%;\n  left: 50%;\n  margin-left: -160px;\n  margin-top: -120px;\n  width: 320px;\n  height: 240px;\n  z-index: 9;\n  pointer-events: none;\n}\n\n#fps {\n  text-align: right;\n  padding-right: 1em;\n}\n\n#warning {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  z-index: 100;\n  background-color: #fff;\n  color: #000;\n}\n\n.hidden {\n  display: none !important;\n}\n\n.inventory-center {\n  margin-top: 1.5em;\n  text-align: center;\n}\n",""]),t.exports=e},function(t,e,n){"use strict";n.r(e);var i=n(0),o=n.n(i),s=n(1),r=n.n(s),a=n(3),c=n.n(a),u={height:1.5,radius:.1,mass:32,linearAcceleration:20,angularAcceleration:4*Math.PI,linearFriction:.5,angularFriction:1,coefficientOfRestitution:0},l={startState:{position:[-1.2676633596420288,.2047852873802185,12.595427513122559],rotation:[0,.4536385088584658,0,.8911857849408661]},goal:{position:[2.2896811962127686,.11950381100177765,16.97636604309082]}},h={height:480,width:640},d=-1===window.location.href.indexOf("localhost")?"https://habitat-resources.s3.amazonaws.com/data/scene_datasets/habitat-test-scenes/skokloster-castle.glb":"skokloster-castle.glb",f=["cylinderSolid_rings_1_segments_12_halfLen_1_useTexCoords_false_useTangents_false_capEnds_true"],p={objects:[{object:"sphere",objectIcon:"/data/test_assets/objects/sphere.png",objectHandle:"/data/objects/sphere.phys_properties.json",physicsProperties:"test_assets/objects/sphere.phys_properties.json",renderMesh:"test_assets/objects/sphere.glb"},{object:"mini_soccer_ball",objectIcon:"/data/test_assets/objects/mini_soccer_ball.png",objectHandle:"/data/objects/mini_soccer_ball.phys_properties.json",physicsProperties:"test_assets/objects/mini_soccer_ball.phys_properties.json",renderMesh:"test_assets/objects/mini_soccer_ball.glb"},{object:"chair",objectIcon:"/data/test_assets/objects/chair.png",objectHandle:"/data/objects/chair.phys_properties.json",physicsProperties:"test_assets/objects/chair.phys_properties.json",renderMesh:"test_assets/objects/chair.glb"},{object:"colored_wood_blocks",objectIcon:"/data/test_assets/objects/colored_wood_blocks.png",objectHandle:"/data/objects/colored_wood_blocks.phys_properties.json",physicsProperties:"test_assets/objects/colored_wood_blocks.phys_properties.json",renderMesh:"test_assets/objects/colored_wood_blocks.glb"}]},v="rtask.json",g="tasks/rtask.json",y="flythroughInventory.csv",m={tasks:[{name:"task.json",config:"tasks/task.json"}]},b="trainingTask.json",k="tasks/trainingTask.json",w=n(4),j=n.n(w),S=n(9),O=n.n(S);function T(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"==typeof t)return I(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return I(t,e)}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,o=function(){};return{s:o,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw s}}}}function I(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function A(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500,n=!1;return function(){var i=arguments,o=this;n||(t.apply(o,i),n=!0,window.setTimeout((function(){n=!1}),e))}}function C(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=T(window.location.search.substr(1).split("&"));try{for(n.s();!(t=n.n()).done;){var i=t.value,o=i.split("="),s=j()(o,2),r=s[0],a=s[1];r&&a&&(e[r]=decodeURIComponent(a))}}catch(t){n.e(t)}finally{n.f()}return e}function M(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5;return Math.floor(Math.random()*t)}function x(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{encoding:"utf8"},n=FS.readFile(t,{encoding:e.encoding}),i=JSON.parse(n);return i}function P(t){return void 0===t?l:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"task.json",e=x(t),n={startState:{}};return n.startState.position=e.episodes[0].start_position,n.startState.rotation=e.episodes[0].start_rotation,n.sceneID=e.episodes[0].scene_id,n.objects=e.episodes[0].objects,n.task=e.episodes[0].task,n}(t)}var E=function(){function t(e){o()(this,t),this.psiturk=e}return r()(t,[{key:"handleRecordTrialData",value:function(t,e,n){this.psiturk&&0==window.config.disableLogging&&this.psiturk.recordTrialData({phase:t,event:e,data:n})}},{key:"handleRecordUnstructuredData",value:function(t,e){this.psiturk&&0==window.config.disableLogging&&this.psiturk.recordUnstructuredData(t,e)}}]),t}();function D(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"==typeof t)return R(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return R(t,e)}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,o=function(){};return{s:o,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw s}}}}function R(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}var _=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;o()(this,t),this.sim=new Module.Simulator(e),this.pathfinder=this.sim.getPathFinder(),this.psiturk=new E(window.psiTurk),this.setEpisode(n),this.resolution=null,this.grippedObjectId=-1,this.nearestObjectId=-1,this.gripOffset=null,this.selectedAgentId=i,window.config.recomputeNavMesh&&this.recomputeNavMesh()}return r()(t,[{key:"reset",value:function(){(this.sim.reset(),null!==this.initialAgentState)&&this.sim.getAgent(this.selectedAgentId).setState(this.initialAgentState,!0);this.updateCrossHairNode(this.getCrosshairPosition()),this.grippedObjectId=-1,this.gripOffset=null,this.psiturk.handleRecordTrialData("TEST","simReset",{})}},{key:"changeAgent",value:function(t){this.selectedAgentId=t}},{key:"setEpisode",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.removeAllObjects(),console.log("removed"),this.episode=t,this.initialAgentState=null,this.objectsInScene=[],Object.keys(t).length>0){this.initialAgentState=this.createAgentState(t.startState);var e=t.objects;for(var n in e){var i=e[n].objectHandle,o=this.convertVec3fToVector3(e[n].position),s=this.addObjectAtLocation(i,o);this.addObjectInScene(s,e[n])}this.recomputeNavMesh()}console.log(this.objectsInScene),this.psiturk.handleRecordTrialData("TEST","setEpisode",{episode:t})}},{key:"updateCrossHairNode",value:function(t){this.sim.updateCrossHairNode(t)}},{key:"addObjectInScene",value:function(t,e){var n=JSON.parse(JSON.stringify(e));n.objectId=t,this.objectsInScene.push(n)}},{key:"updateObjectInScene",value:function(t,e){for(var n=0;n<this.objectsInScene.length;n++)if(this.objectsInScene[n].objectId==t){this.objectsInScene[n].objectId=e;break}}},{key:"getObjectFromScene",value:function(t){for(var e=0;e<this.objectsInScene.length;e++)if(this.objectsInScene[e].objectId==t)return this.objectsInScene[e];return null}},{key:"getObjectsInScene",value:function(){return this.objectsInScene}},{key:"syncObjects",value:function(){this.sim.syncGrippedObject(this.grippedObjectId)}},{key:"addObjectAtLocation",value:function(t,e){var n=this.addObjectByHandle(t);return this.setTranslation(e,n,0),this.sampleObjectState(n,0),this.setObjectMotionType(Module.MotionType.DYNAMIC,n,0),n}},{key:"removeAllObjects",value:function(){for(var t=this.getExistingObjectIDs(),e=0;e<t.size();e++)this.removeObject(t.get(e))}},{key:"step",value:function(t){this.sim.getAgent(this.selectedAgentId).act(t)}},{key:"addAgent",value:function(t){var e=this.createAgentConfig(t);return this.resolution=this.flipVec2i(e.sensorSpecifications.get(0).resolution),this.sim.addAgent(e)}},{key:"addObject",value:function(t){return this.sim.addObject(t,null,"",0)}},{key:"removeObject",value:function(t){this.sim.removeObject(t,!0,!0,0)}},{key:"addObjectByHandle",value:function(t){return this.sim.addObjectByHandle(t,null,"",0)}},{key:"addPrimitiveObject",value:function(){var t=M(f.length),e=f[t],n=this.addObjectByHandle(e),i=this.getAgentTransformation(0).transformPoint(new Module.Vector3(.1,1.5,-1.5));return this.setTranslation(i,n,0),n}},{key:"addTemplateObject",value:function(){var t=M(p.objects.length),e=p.objects[t].objectHandle,n=this.addObjectByHandle(e),i=this.getAgentTransformation(0).transformPoint(new Module.Vector3(.1,1.5,-1.5));return this.setTranslation(i,n,0),this.addObjectInScene(n,p.objects[t]),n}},{key:"removeLastObject",value:function(){var t=this.getExistingObjectIDs();this.removeObject(t.get(t.size()-1))}},{key:"grabReleaseObject",value:function(){var t=this.getObjectUnderCrosshair(),e=this.getAgentTransformation(0);if(-1!=this.grippedObjectId){this.setTransformation(e.mul(this.gripOffset),this.grippedObjectId,0);var n=this.getTranslation(this.grippedObjectId,0);if(!this.pathfinder.isNavigable(this.convertVector3ToVec3f(n),.5))return void console.log("Colliding with object or position is not navigable");this.setObjectMotionType(Module.MotionType.STATIC,this.grippedObjectId,0),this.grippedObjectId=-1,this.drawBBAroundNearestObject()}else{if(-1==t)return;this.gripOffset=e.inverted().mul(this.getTransformation(t,0)),this.setObjectMotionType(Module.MotionType.KINEMATIC,t,0),this.grippedObjectId=t}this.recomputeNavMesh()}},{key:"inventoryGrabReleaseObject",value:function(){var t=this.getObjectUnderCrosshair();if(-1!=this.grippedObjectId){var e=this.getCrosshairPosition(),n=this.unproject(e).direction,i=this.getAgentTransformation(0),o=this.sim.findFloorPositionUnderCrosshair(n,i,this.resolution,1.5).point;if(null==o)return!0;var s=o.y();this.grippedObjectTransformation.translation().y()>=s&&(s=this.grippedObjectTransformation.translation().y());var r=new Module.Vector3(o.x(),s,o.z()),a=this.getObjectFromScene(this.grippedObjectId),c=this.addObjectByHandle(a.objectHandle);for(this.setTranslation(r,c,0);this.sim.contactTest(c,0);)r=new Module.Vector3(r.x(),r.y()+.25,r.z()),this.setTranslation(r,c,0);this.updateObjectInScene(this.grippedObjectId,c),this.grippedObjectId=-1}else{if(-1==t)return!1;this.grippedObjectTransformation=this.getTransformation(t,0),this.removeObject(t,0),this.grippedObjectId=t}return!1}},{key:"getObservationSpace",value:function(t){return this.sim.getAgentObservationSpace(this.selectedAgentId,t)}},{key:"getObservation",value:function(t,e){return this.sim.getAgentObservation(this.selectedAgentId,t,e),e}},{key:"getPathFinder",value:function(){return this.sim.getPathFinder()}},{key:"getObjectMotionType",value:function(t,e){return this.sim.getObjectMotionType(t,e)}},{key:"setObjectMotionType",value:function(t,e,n){return this.sim.setObjectMotionType(t,e,n)}},{key:"getExistingObjectIDs",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.sim.getExistingObjectIDs(t)}},{key:"setTransformation",value:function(t,e,n){this.sim.setTransformation(t,e,n)}},{key:"getTransformation",value:function(t,e){return this.sim.getTransformation(t,e)}},{key:"getTranslation",value:function(t,e){return this.sim.getTranslation(t,e)}},{key:"setTranslation",value:function(t,e,n){this.sim.setTranslation(t,e,n)}},{key:"getRotation",value:function(t,e){return this.sim.getRotation(t,e)}},{key:"setRotation",value:function(t,e,n){this.sim.setRotation(t,e,n)}},{key:"setObjectBBDraw",value:function(t,e,n){this.sim.setObjectBBDraw(t,e,n)}},{key:"stepWorld",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/60;return this.sim.stepWorld(t)}},{key:"getWorldTime",value:function(){return this.sim.getWorldTime()}},{key:"displayObservation",value:function(t){this.sim.displayObservation(0,t)}},{key:"getSemanticScene",value:function(){return this.sim.getSemanticScene()}},{key:"getAgent",value:function(t){return this.sim.getAgent(t)}},{key:"getAgentTransformation",value:function(t){return this.sim.getAgentTransformation(t)}},{key:"getAgentAbsoluteTranslation",value:function(t){return this.sim.getAgentAbsoluteTranslation(t)}},{key:"getAgentState",value:function(){var t=new Module.AgentState;return this.sim.getAgent(this.selectedAgentId).getState(t),t}},{key:"getCrosshairPosition",value:function(){return this.resolution.map((function(t){return.5*t}))}},{key:"getObjectUnderCrosshair",value:function(){var t=this.getCrosshairPosition(),e=this.unproject(t).direction,n=this.getAgentAbsoluteTranslation(0);return this.findNearestObjectUnderCrosshair(e,n,this.resolution)}},{key:"drawBBAroundNearestObject",value:function(){var t=this.getObjectUnderCrosshair();-1==t?-1!=this.nearestObjectId&&this.grippedObjectId!=this.nearestObjectId&&(this.setObjectBBDraw(!1,this.nearestObjectId,0),this.nearestObjectId=t):(-1!=this.nearestObjectId&&this.grippedObjectId!=this.nearestObjectId&&(this.setObjectBBDraw(!1,this.nearestObjectId,0),this.nearestObjectId=-1),this.nearestObjectId!=t&&(this.nearestObjectId=t,this.setObjectBBDraw(!0,this.nearestObjectId,0)))}},{key:"sampleObjectState",value:function(t,e){this.sim.sampleObjectState(t,e)}},{key:"recomputeNavMesh",value:function(){var t=new Module.NavMeshSettings;this.sim.recomputeNavMesh(this.getPathFinder(),t,!0)}},{key:"toggleNavMeshVisualization",value:function(){this.sim.toggleNavMeshVisualization()}},{key:"findNearestObjectUnderCrosshair",value:function(t,e,n){return this.sim.findNearestObjectUnderCrosshair(t,e,n,1.5)}},{key:"unproject",value:function(t){return this.sim.unproject(t)}},{key:"geodesicDistance",value:function(t,e){var n=new Module.ShortestPath;return n.requestedStart=t,n.requestedEnd=e,this.pathfinder.findPath(n),n.geodesicDistance}},{key:"getDistanceBetweenObjects",value:function(t,e){var n=this.getTranslation(t,0),i=this.getTranslation(e,0);return this.geodesicDistance(this.convertVector3ToVec3f(n),this.convertVector3ToVec3f(i))}},{key:"convertVector3ToVec3f",value:function(t){return[t.x(),t.y(),t.z()]}},{key:"convertVec3fToVector3",value:function(t){return new Module.Vector3(t[0],t[1],t[2])}},{key:"flipVec2i",value:function(t){return[t[1],t[0]]}},{key:"distanceToGoal",value:function(){if(0===Object.keys(this.episode).length||void 0===this.episode.goal)return[0,0];var t=this.episode.goal.position,e=this.getAgentState(),n=e.position,i=[t[0]-n[0],t[1]-n[1],t[2]-n[2]];return i=this.applyRotation(i,e.rotation),this.cartesian_to_polar(-i[2],i[0])}},{key:"applyRotation",value:function(t,e){var n,i,o,s,r,a,c,u=j()(t,3);n=u[0],i=u[1],o=u[2];var l=j()(e,4);s=l[0],r=l[1],a=l[2];var h=(c=l[3])*n-r*o+a*i,d=c*i-a*n+s*o,f=c*o-s*i+r*n,p=s*n+r*i+a*o,v=[];return v[0]=h*c+p*s+d*a-f*r,v[1]=d*c+p*r+f*s-h*a,v[2]=f*c+p*a+h*r-d*s,v}},{key:"cartesian_to_polar",value:function(t,e){return[Math.sqrt(t*t+e*e),Math.atan2(e,t)]}},{key:"createSensorSpec",value:function(t){var e=new Module.SensorSpec;for(var n in t){var i=t[n];e[n]=i}return e}},{key:"createAgentConfig",value:function(t){var e=new Module.AgentConfiguration;for(var n in t){var i=t[n];if("sensorSpecifications"===n){var o,s=new Module.VectorSensorSpec,r=D(i);try{for(r.s();!(o=r.n()).done;){var a=o.value;s.push_back(this.createSensorSpec(a))}}catch(t){r.e(t)}finally{r.f()}i=s}e[n]=i}return e}},{key:"createAgentState",value:function(t){var e=new Module.AgentState;for(var n in t){var i=t[n];e[n]=i}return e}}]),t}(),F=function(){function t(e,n){o()(this,t),this.pathFinder=e,this.bounds=e.bounds,this.canvas=n,this.ctx=n.getContext("2d"),this.widthComponent=0,this.heightComponent=2,this.scale=1,this.ctx.strokeStyle="blue",this.ctx.lineWidth=3,this.currentY=-1/0}return r()(t,[{key:"draw",value:function(){var t=this.ctx,e=this.canvas,n=this.mapCenterInset(),i=j()(n,2),o=i[0],s=i[1];t.clearRect(0,0,e.width,e.height),t.putImageData(this.imageData,o,s)}},{key:"start",value:function(t){this.currentY=t[1],this.imageData=this.createMap(),this.draw();var e=this.convertPosition(t),n=j()(e,2),i=n[0],o=n[1];this.ctx.beginPath(),this.ctx.moveTo(i,o)}},{key:"moveTo",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0!==e)this.throttledMoveTo||(this.throttledMoveTo=A(this.moveTo.bind(this),e)),this.throttledMoveTo(t);else if(t[1]<this.currentY-.25||t[1]>this.currentY+.25)this.start(t);else{var n=this.convertPosition(t),i=j()(n,2),o=i[0],s=i[1];this.ctx.lineTo(o,s),this.ctx.stroke()}}},{key:"mapCenterInset",value:function(){return[(this.canvas.width-this.imageData.width)/2,(this.canvas.height-this.imageData.height)/2]}},{key:"convertPosition",value:function(t){var e=this.widthComponent,n=this.heightComponent,i=this.mapCenterInset(),o=j()(i,2),s=o[0],r=o[1];return[s+=(t[e]-this.bounds.min[e])*this.scale,r+=(t[n]-this.bounds.min[n])*this.scale]}},{key:"createMap",value:function(){var t=this.canvas,e=this.bounds.max[0]-this.bounds.min[0],n=this.bounds.max[2]-this.bounds.min[2],i=0,o=0;if(e>n&&t.width<t.height||e<n&&t.width>t.height){this.widthComponent=2,this.heightComponent=0;var s=e;e=n,n=s}n/e>t.height/t.width?(this.scale=t.height/n,i=t.height,o=Math.round(e*this.scale-.5)):(this.scale=t.width/e,o=t.width,i=Math.round(n*this.scale-.5));var r,a,c=new ImageData(o,i),u=4*t.width,l=1/this.scale,h=this.bounds.min[this.heightComponent]+l/2;for(r=0;r<i;r++){var d=this.bounds.min[this.widthComponent]+l/2;for(a=0;a<o;a++){var f=[0,this.currentY,0];f[this.widthComponent]=d,f[this.heightComponent]=h,this.pathFinder.isNavigable(f,.5)&&(c.data[r*u+4*a]=255,c.data[r*u+4*a+1]=255,c.data[r*u+4*a+2]=255,c.data[r*u+4*a+3]=255),d+=l}h+=l}return c}}]),t}(),V=function(){function t(e,n,i,s){o()(this,t),this.rect=e,this.semanticShape=n,this.semanticScene=i,this.objectIds=[];for(var r=this.semanticScene.categories,a=this.semanticScene.objects,c=-1,u=0;u<r.size();u++){var l=r.get(u);if(l&&l.getName("")===s){c=l.getIndex("");break}}for(var h=0;h<a.size();h++){var d=a.get(h)||{};d.category&&d.category.getIndex("")===c&&this.objectIds.push(h)}}return r()(t,[{key:"computeIOU",value:function(t){for(var e=this.semanticShape.get(1),n=this.semanticShape.get(0),i=this.rect.left,o=this.rect.top,s=this.rect.right,r=this.rect.bottom,a=0,c=0,u=!1,l=0;l<n;l++){u=l>=o&&l<r;for(var h=0;h<e;h++)this.objectIds.includes(t[l*e+h])&&(u&&h>=i&&h<s?a++:c++)}return 0===a?0:a/(c+(r-o)*(s-i))}}]),t}(),B=function(){function t(e){o()(this,t),this.inventorySlots=e,this.inventory=new Array(e),this.inventoryComponent=null,this.inventoryEnabled=!1,this.inventoryCtx=null}return r()(t,[{key:"reset",value:function(){this.inventory=new Array(this.inventorySlots)}},{key:"initInventory",value:function(t){this.inventoryComponent=t,this.inventoryEnabled=!0,this.inventoryCtx=t.getContext("2d")}},{key:"setSlot",value:function(t,e){this.inventory[t]=e}},{key:"getSlot",value:function(t){return this.inventory[t]}},{key:"getEmptySlot",value:function(){for(var t=0;t<this.inventorySlots;t++)if(void 0===this.inventory[t])return t;return-1}},{key:"findObjectSlot",value:function(t){for(var e=0;e<this.inventorySlots;e++)if(void 0!==this.inventory[e]&&this.inventory[e].objectId===t)return e;return-1}},{key:"renderInventory",value:function(){var t=this;if(this.inventoryEnabled){var e=80*this.inventorySlots;""===this.inventoryComponent.style.border&&(this.inventoryComponent.style.border="5px solid #000000",this.inventoryComponent.width=e.toString());var n=this.inventoryCtx;n.clearRect(0,0,e,80),n.fillStyle="darkslategray";for(var i=function(e){var i=2+78*e;n.beginPath(),n.strokeStyle="grey",n.lineWidth=5,n.rect(i,2,76,76),n.stroke(),n.closePath();if(void 0!==t.inventory[e]){var o=new Image;o.src=t.inventory[e].objectIcon,o.addEventListener("load",(function(){n.drawImage(o,i+2,4,72,72)}))}},o=0;o<this.inventorySlots;++o)i(o)}}}]),t}(),L=function(){function t(e,n){o()(this,t),this.episode=e,this.sim=n,this.task=this.episode.task}return r()(t,[{key:"validate",value:function(){return void 0===this.task||("arrangement"===this.task.type?this.validateArrangementTask():"stacking"===this.task.type?this.validateStackingTask():void 0)}},{key:"validateArrangementTask",value:function(){var t=this.task.goal;if(void 0===t||void 0===t.objectToGoalMap)return!0;var e=t.objectToGoalMap,n=this.sim.getObjectsInScene();for(var i in e){for(var o=n[parseInt(i)].objectId,s=e[i],r=!1,a=0;a<s.length;a++){var c=n[s[a]].objectId;this.sim.getDistanceBetweenObjects(o,c)<=2&&(r=!0)}if(!r)return!1}return!0}},{key:"validateStackingTask",value:function(){}}]),t}();function N(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"==typeof t)return H(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return H(t,e)}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,o=function(){};return{s:o,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,r=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return r=t.done,t},e:function(t){a=!0,s=t},f:function(){try{r||null==n.return||n.return()}finally{if(a)throw s}}}}function H(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}var W=function(){function t(e,n){var i=this;if(o()(this,t),this.sim=e,this.components=n,this.topdown=n.topdown,this.semanticsEnabled=!1,this.radarEnabled=!1,this.keyBindListener=null,this.lastInteractedObjectId=-1,this.inventory=new B(1),this.taskValidator=null,this.components.semantic){if(this.semanticsEnabled=!0,this.semanticCtx=n.semantic.getContext("2d"),this.semanticShape=this.sim.getObservationSpace("semantic").shape,this.semanticImageData=this.semanticCtx.createImageData(this.semanticShape.get(1),this.semanticShape.get(0)),this.semanticObservation=new Module.Observation,this.semanticScene=this.sim.sim.getSemanticScene(),this.semanticObjects=this.semanticScene.objects,window.config.category){var s=this.components.scope.offsetWidth,r=this.components.scope.offsetHeight,a=(this.components.canvas.width-s)/2,c=(this.components.canvas.height-r)/2,u={left:a,top:c,right:a+s,bottom:c+r};this.objectSensor=new V(u,this.semanticShape,this.semanticScene,window.config.category)}n.canvas.onmousedown=function(t){i.handleMouseDown(t)}}this.components.radar&&(this.radarEnabled=!0,this.radarCtx=n.radar.getContext("2d")),this.components.inventory&&this.inventory.initInventory(n.inventory),this.components.taskValidator&&(this.taskValidator=this.components.taskValidator),this.psiturk=new E(window.psiTurk),this.actions=[{name:"moveForward",key:"w",keyCode:87},{name:"moveBackward",key:"s",keyCode:83},{name:"turnLeft",key:"ArrowLeft",keyCode:37},{name:"turnRight",key:"ArrowRight",keyCode:39},{name:"turnLeft",key:"a",keyCode:65},{name:"turnRight",key:"d",keyCode:68},{name:"lookUp",key:"ArrowUp",keyCode:38},{name:"lookDown",key:"ArrowDown",keyCode:40},{name:"grabReleaseObject",key:" ",keyCode:32},{name:"addTemplateObject",key:"o",keyCode:79}]}return r()(t,[{key:"handleMouseDown",value:function(t){var e=this.semanticShape.get(0),n=this.semanticShape.get(1),i=e-1-t.offsetY,o=t.offsetX,s=this.semanticData[n*i+o];this.setStatus(this.semanticObjects.get(s).category.getName(""))}},{key:"init",value:function(){this.bindKeys(),this.psiturk.handleRecordTrialData("TEST","simInitialized",{config:window.config}),this.initialized=!0,this.initPhysics()}},{key:"initPhysics",value:function(){var t=this;Module.enablePhysics&&!0!==window.config.runFlythrough&&(console.log("enabled step"),this.physicsStepFunction=setInterval((function(){t.psiturk.handleRecordTrialData("TEST","stepPhysics",{step:.1}),t.sim.stepWorld(.1),t.render()}),100))}},{key:"disablePhysics",value:function(){this.physicsStepFunction&&(console.log("clearing"),window.clearInterval(this.physicsStepFunction))}},{key:"reset",value:function(){this.disablePhysics(),this.sim.reset(),this.inventory.reset(),this.inventory.renderInventory(),this.setStatus("Ready"),this.initPhysics(),this.render()}},{key:"runFlythrough",value:function(){var t=this;this.setStatus("Initializing...");var e=this;this.psiturk.handleRecordTrialData("TEST","flythroughStart",{});var n=!!this.keyBindListener;this.unbindKeys();var i=FS.readFile("/data/".concat(window.config.flythroughFile),{encoding:"utf8"}).split(/\r?\n/),o=null,s=0,r=!1;this.replayTimeouts=[];for(var a=function(n){var a=i[n];if(0===a.length)return"continue";var c=a.split(","),u=c.slice(0,3)[2],l=c.slice(3).join(",");'"'==l[0]&&'"'==l[l.length-1]&&(l=function(t,e,n){for(;-1!==t.indexOf(e);)t=t.replace(e,n);return t}(l=l.slice(1,l.length-1),'""','"'));var h=JSON.parse(l);if(!1===r){if("viewer"!==h.step)return"continue";r=!0}o||(o=u);var d=(u-o)/1,f=window.setTimeout((function(){"simReset"===h.event?e.reset():"handleAction"==h.event?(console.log(h.data.action+" "+e.sim.getWorldTime()),e.handleAction(h.data.action)):"stepPhysics"==h.event&&(console.log("stepPhysics "+e.sim.getWorldTime()),e.sim.stepWorld(.1),e.render())}),d);t.replayTimeouts.push(f),s=d},c=0;c<i.length;++c)a(c);this.clearTimeouts=function(){if(this.clearTimeouts=null,this.replayTimeouts){for(var t=0;t<this.replayTimeouts.length;++t){var i=this.replayTimeouts[t];window.clearTimeout(i)}delete this.replayTimeouts}n&&e.bindKeys(),e.setStatus("")};var u=window.setTimeout((function(){"function"==typeof this.clearTimeouts&&this.clearTimeouts(),window.finishTrial()}),s+1);this.replayTimeouts.push(u),console.log("end"),this.psiturk.handleRecordTrialData("TEST","flythroughEnd",{})}},{key:"setTaskValidator",value:function(t){this.taskValidator=new L(t,this.sim)}},{key:"setStatus",value:function(t){this.components.status.style="color:white",this.components.status.innerHTML=t}},{key:"setErrorStatus",value:function(t){this.components.status.style="color:red",this.components.status.innerHTML=t}},{key:"setWarningStatus",value:function(t){this.components.status.style="color:orange",this.components.status.innerHTML=t}},{key:"setSuccessStatus",value:function(t){this.components.status.style="color:green",this.components.status.innerHTML=t}},{key:"renderImage",value:function(){this.sim.displayObservation("rgb"),this.renderRadar()}},{key:"renderSemanticImage",value:function(){if(this.semanticsEnabled&&0!=this.semanticObjects.size()){this.sim.getObservation("semantic",this.semanticObservation);var t=this.semanticObservation.getData(),e=new Uint32Array(t.buffer,t.byteOffset,t.length/4);this.semanticData=e;for(var n=0;n<e.length;n++){var i=e[n];this.semanticImageData.data[4*n]=1&i?255:0,this.semanticImageData.data[4*n+1]=2&i?255:0,this.semanticImageData.data[4*n+2]=4&i?255:0,this.semanticImageData.data[4*n+3]=255}this.semanticCtx.putImageData(this.semanticImageData,0,0)}}},{key:"renderTopDown",value:function(t){t.renderTopDown&&null!==this.topdown&&this.topdown.moveTo(this.sim.getAgentState().position,500)}},{key:"renderRadar",value:function(){if(this.radarEnabled){var t,e,n=this.radarCtx;n.clearRect(0,0,100,100),n.globalAlpha=.5,n.fillStyle="darkslategray",n.arc(50,50,50,0,2*Math.PI),n.fill(),n.fillStyle="darkgray",n.beginPath(),n.arc(50,50,50,3*-Math.PI/4,-Math.PI/4),n.lineTo(50,50),n.closePath(),n.fill(),n.globalAlpha=1,n.beginPath();var i=this.sim.distanceToGoal(),o=j()(i,2);t=o[0],e=o[1];var s=t/(t+1),r=50+50*Math.sin(e)*s,a=50-50*Math.cos(e)*s;n.fillStyle="maroon",n.arc(r,a,3,0,2*Math.PI),n.fill()}}},{key:"render",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{renderTopDown:!0};this.renderImage(),this.sim.updateCrossHairNode(this.sim.getCrosshairPosition()),this.sim.drawBBAroundNearestObject(),this.renderImage(),this.renderSemanticImage(),this.renderTopDown(t)}},{key:"handleInventoryUpdate",value:function(t){var e=this.sim.grippedObjectId;if(t)this.setStatus("Collision while releasing object!");else{if(-1==e){var n=this.inventory.findObjectSlot(this.lastInteractedObjectId);if(-1!=n&&this.inventory.setSlot(n,void 0),-1!=this.lastInteractedObjectId){var i=this.sim.getObjectFromScene(this.lastInteractedObjectId);this.setStatus(i.object+" released")}}else{var o=this.inventory.getEmptySlot(),s=this.sim.getObjectFromScene(e);-1==o?console.log("No empty slot in inventory!"):(this.inventory.setSlot(o,{objectId:e,object:s.object,objectIcon:s.objectIcon}),this.setStatus(s.object+" picked up"))}this.lastInteractedObjectId=e}}},{key:"handleAction",value:function(t){if("addPrimitiveObject"===t)this.sim.addPrimitiveObject();else if("addTemplateObject"===t)this.sim.addTemplateObject();else if("removeLastObject"===t)this.sim.removeLastObject();else if("grabReleaseObject"==t){var e=this.sim.inventoryGrabReleaseObject();this.handleInventoryUpdate(e),this.inventory.renderInventory(),-1===this.sim.grippedObjectId&&this.taskValidator.validate()&&window.finishTrial&&(this.setStatus("Task completed!"),setTimeout(window.finishTrial,500))}else this.sim.step(t),this.setStatus(t);this.render()}},{key:"handleKeypress",value:function(t){var e,n=N(this.actions);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(i.keyCode===t){this.psiturk.handleRecordTrialData("TEST","handleAction",{action:i.name}),this.handleAction(i.name);break}}}catch(t){n.e(t)}finally{n.f()}}},{key:"bindKeys",value:function(){var t=this;t.keyBindListener?console.log("Keys already bound. Returning"):(t.keyBindListener=function(e){e.preventDefault(),t.handleKeypress(e.keyCode)},document.addEventListener("keydown",t.keyBindListener,!0))}},{key:"unbindKeys",value:function(){this.keyBindListener&&(document.removeEventListener("keydown",this.keyBindListener,!0),this.keyBindListener=null)}}]),t}();function z(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function U(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?z(Object(n),!0).forEach((function(e){c()(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):z(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var G=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"canvas";o()(this,t),c()(this,"currentResolution",h),this.canvasId=e}return r()(t,[{key:"initializeModules",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.sceneConfig=new Module.SceneConfiguration,this.sceneConfig.id=Module.scene,this.config=new Module.SimulatorConfiguration,this.config.scene=this.sceneConfig,this.config.enablePhysics=Module.enablePhysics,this.config.physicsConfigFile=Module.physicsConfigFile,this.simenv=new _(this.config,e,0),t=this.updateAgentConfigWithSensors(U({},t)),this.simenv.addAgent(t),this.simenv.updateCrossHairNode(this.simenv.resolution),this.topdown=n?new F(this.simenv.getPathFinder(),document.getElementById("topdown")):null,this.canvasElement=document.getElementById(this.canvasId),this.taskValidator=new L(e,this.simenv),this.task=new W(this.simenv,{topdown:this.topdown,canvas:this.canvasElement,inventory:document.getElementById("inventory"),semantic:document.getElementById("semantic"),radar:document.getElementById("radar"),scope:document.getElementById("scope"),status:document.getElementById("status"),taskValidator:this.taskValidator})}},{key:"setEpisode",value:function(t){var e=document.getElementById("task-instruction");null!=e&&(console.log(e),e.innerHTML="<hr> <h1>Task: "+t.task.instruction+"</h1> <hr>"),this.simenv.setEpisode(t)}},{key:"setTaskValidator",value:function(t){this.task.setTaskValidator(t)}},{key:"runFlythrough",value:function(){window.config.disableLogging=!0,window.config.runFlythrough=!0;var t=P("/data/".concat(v));this.setEpisode(t),this.setTaskValidator(t),this.task.reset(),this.task.runFlythrough()}},{key:"runInit",value:function(){window.config.disableLogging=!1,window.config.runFlythrough=!1;var t=P("/data/".concat(window.config.taskConfig.name));this.setEpisode(t),this.setTaskValidator(t),this.task.reset()}},{key:"runTrainingTask",value:function(){window.config.disableLogging=!0,window.config.runFlythrough=!1;var t=P("/data/".concat(b));this.setEpisode(t),this.setTaskValidator(t),this.task.reset()}},{key:"updateAgentConfigWithSensors",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u,e=[{uuid:"rgb",sensorType:Module.SensorType.COLOR,resolution:[480,640]},{uuid:"semantic",sensorType:Module.SensorType.SEMANTIC,resolution:[480,640],channels:1}];return t.sensorSpecifications=e,t=this.updateAgentConfigWithResolution(t)}},{key:"resetCanvas",value:function(t){this.canvasElement.width=t.width,this.canvasElement.height=t.height}},{key:"updateAgentConfigWithResolution",value:function(t){var e=this;return t.sensorSpecifications.forEach((function(t){t.resolution=[e.currentResolution.height,e.currentResolution.width]})),t}},{key:"display",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=C();n.useDefaultEpisode&&(e=l),this.initializeModules(t,e),this.task.init(),this.task.reset()}}]),t}(),K=n(2),Y=n.n(K),q=n(6),J=n.n(q),$=n(7),X=n.n($),Q=n(8),Z=n.n(Q),tt=n(5),et=n.n(tt);function nt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=et()(t);if(e){var o=et()(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return Z()(this,n)}}var it=function(t){X()(n,t);var e=nt(n);function n(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"canvas",s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"fps";return o()(this,n),t=e.call(this),c()(Y()(t),"normalSceneFrame",void 0),c()(Y()(t),"vrSceneFrame",void 0),c()(Y()(t),"fpsElement",void 0),c()(Y()(t),"lastPaintTime",void 0),c()(Y()(t),"frameData",new VRFrameData),c()(Y()(t),"previousRotation",!1),c()(Y()(t),"previousPosition",!1),c()(Y()(t),"currentVrDisplay",!1),c()(Y()(t),"fps",0),c()(Y()(t),"skipFrames",60),c()(Y()(t),"currentFramesSkipped",0),t.canvasElement=document.getElementById(i),t.fpsElement=document.getElementById(s),t}return r()(n,[{key:"display",value:function(){this.setUpVR()}},{key:"initializeModules",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];J()(et()(n.prototype),"initializeModules",this).call(this,t,e,i)}},{key:"setUpVR",value:function(){var t=this;navigator.getVRDisplays().then((function(e){e.length>0?t.setupDisplay(e[0]):(console.log("VR display not supported by this device"),J()(et()(n.prototype),"display",t).call(t))}))}},{key:"setupDisplay",value:function(t){var e=this;this.currentVrDisplay=t,this.currentVrDisplay.requestPresent([{source:this.canvasElement}]).then((function(){return e.setupCanvas()})).then((function(){return e.initializeModules()})).then((function(){return e.renderDisplay()}))}},{key:"renderDisplay",value:function(){this.task.reset(),this.drawVRScene()}},{key:"setupCanvas",value:function(){var t=this.currentVrDisplay.getEyeParameters("left"),e=this.currentVrDisplay.getEyeParameters("right"),n=2*Math.max(t.renderWidth,e.renderWidth),i=Math.max(t.renderHeight,e.renderHeight);this.currentResolution={height:i,width:n},this.resetCanvas(this.currentResolution)}},{key:"drawVRScene",value:function(){this.vrSceneFrame=this.currentVrDisplay.requestAnimationFrame(this.drawVRScene.bind(this)),this.currentVrDisplay.getFrameData(this.frameData),this.updateAgentState(),this.task.render({renderTopDown:!1}),this.currentVrDisplay.submitFrame(),this.updateFPS()}},{key:"updateAgentState",value:function(){var t=this,e=this.simenv.sim.getAgent(this.simenv.selectedAgentId),n=this.simenv.createAgentState({});e.getState(n);var i=n.rotation.slice(),o=n.position.slice();if(this.previousRotation){var s=this.frameData.pose.orientation,r=this.frameData.pose.position;s.forEach((function(e,n){i[n]+=e-t.previousRotation[n]})),r.forEach((function(e,n){o[n]+=e-t.previousPosition[n]})),this.previousRotation=s.slice(),this.previousPosition=r.slice()}else this.previousRotation=this.frameData.pose.orientation.slice(),this.previousPosition=this.frameData.pose.position.slice();var a={position:o,rotation:i};a=this.simenv.createAgentState(a),e.setState(a,!0)}},{key:"updateFPS",value:function(){if(this.currentFramesSkipped==this.skipFrames)if(this.currentFramesSkipped=0,this.lastPaintTime){var t=performance.now(),e=(t-this.lastPaintTime)/1e3;this.fps=this.skipFrames/e,this.lastPaintTime=t,this.fpsElement.innerHTML="FPS: ".concat(this.fps.toFixed(2))}else this.lastPaintTime=performance.now();else this.currentFramesSkipped++}}]),n}(G);n(19);function ot(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=et()(t);if(e){var o=et()(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return Z()(this,n)}}var st=function(t){X()(n,t);var e=ot(n);function n(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"canvas";return o()(this,n),(t=e.call(this,i)).canvasElement=document.getElementById(i),window.addEventListener("resize",t.windowResizeEvent.bind(Y()(t))),t}return r()(n,[{key:"initializeModules",value:function(){for(var t,e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];3===i.length?i[2]=!1:2==i.length&&i.push(!1),(t=J()(et()(n.prototype),"initializeModules",this)).call.apply(t,[this].concat(i))}},{key:"resetCanvasToCurrent",value:function(){this.currentResolution={height:this.canvasElement.offsetHeight,width:this.canvasElement.offsetWidth},this.resetCanvas(this.currentResolution)}},{key:"display",value:function(){this.resetCanvasToCurrent(),J()(et()(n.prototype),"display",this).call(this)}},{key:"windowResizeEvent",value:function(){}}]),n}(G);n(21);function rt(t){var e=t;if(0===t.indexOf("http")){var n=t.split("/");e=n[n.length-1]}return FS.createPreloadedFile("/",e,"data/scenes/".concat(t),!0,!1),e}Module.preRun.push((function(){var t={};t.scene=d,C(t),window.config=t,window.config.taskConfig=m.tasks[parseInt(window.config.task)];var e=t.scene;Module.scene=rt(e);var n=window.config.defaultPhysConfig;Module.physicsConfigFile=function(t){FS.mkdir("/data");var e=t;if(0===t.indexOf("http")){var n=t.split("/");e=n[n.length-1]}FS.createPreloadedFile("/data",e,"data/".concat(t),!0,!1);var i="/data".concat("/objects");FS.mkdir(i);var o=p.objects;for(var s in o){var r=o[s].physicsProperties,a=r.split("/")[r.split("/").length-1],c=o[s].renderMesh,u=c.split("/")[c.split("/").length-1];FS.createPreloadedFile(i,u,"data/".concat(c),!0,!1),FS.createPreloadedFile(i,a,"data/".concat(r),!0,!1)}var l=m.tasks;for(var h in l){var d=l[h].name,f=l[h].config;void 0!==window.config.taskConfig&&d==window.config.taskConfig.name&&FS.createPreloadedFile("/data",d,"data/".concat(f),!0,!1)}return FS.createPreloadedFile("/data",b,"data/".concat(k),!0,!1),"/data".concat("/".concat(e))}(n),Module.enablePhysics="true"===window.config.enablePhysics,window.config.runFlythrough="true"===window.config.runFlythrough;var i,o=e.substr(0,e.lastIndexOf("."));void 0!==window.config.flythroughFile&&null!==window.config.flythroughFile||(window.config.flythroughFile=y),i=window.config.flythroughFile,FS.createPreloadedFile("/data",v,"data/".concat(g),!0,!1),FS.createPreloadedFile("/data",i,"data/replays/".concat(i),!0,!1),window.config.recomputeNavMesh||rt(o+".navmesh"),"mp3d"===t.semantic?(rt(o+".house"),rt(o+"_semantic.ply")):"replica"===t.semantic&&rt(function(t){var e=t.split("/"),n=e.length>1;e.pop();var i="info_semantic.json";return n&&(i="/"+i),e.join("/")+i}(t.scene))})),Module.onRuntimeInitialized=function(){var t;if(console.log("hsim_bindings initialized"),window.vrEnabled?navigator&&navigator.getVRDisplays&&(console.log("Web VR is supported"),t=new it):window.viewerEnabled&&(t=new st),t||(t=new G),void 0!==window.config.taskConfig){var e=P("/data/".concat(window.config.taskConfig.name));t.display(void 0,e)}else t.display();!0===window.config.runFlythrough&&t.runFlythrough(),window.demo=t},function(){var t=function(){var t,e,n=!1;try{e=(t=document.createElement("canvas")).getContext("webgl")||t.getContext("experimental-webgl")}catch(t){return}return void 0!==e&&(n=!0),t=void 0,n?2:"undefined"!=typeof WebGL2RenderingContext?1:0}(),e="";if(t?1===t&&(e="WebGL2 is supported on your browser, but not enabled. "):e="WebGL2 is not supported on your browser. ",function(){try{if("object"===("undefined"==typeof WebAssembly?"undefined":O()(WebAssembly))&&"function"==typeof WebAssembly.instantiate){var t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){return!1}return!1}()||(e+="Web Assembly is not supported in your browser"),e.length>0){var n=document.getElementById("warning");n.innerHTML=e,n.className=""}}()}]);
//# sourceMappingURL=bundle.js.map